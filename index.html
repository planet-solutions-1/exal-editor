<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Editor - Rapid Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9F9F7;
            /* Washi Paper White */
            color: #2C3E50;
            /* Ink Blue */
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Noto Serif JP', serif;
        }

        .cell-input {
            transition: all 0.2s;
        }

        .cell-input:focus {
            outline: none;
            background-color: #FFFFFF;
            box-shadow: inset 0 0 0 1px #4A5568;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #FFFFFF;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        /* Custom Select Style */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%234A5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-action {
            background-color: #4A5568;
            color: white;
            transition: all 0.2s;
        }

        .btn-action:hover {
            background-color: #2D3748;
        }

        .btn-outline {
            background-color: #FFFFFF;
            border: 1px solid #E2E8F0;
            color: #4A5568;
            transition: all 0.2s;
        }

        .btn-outline:hover {
            background-color: #F7FAFC;
            border-color: #CBD5E0;
        }

        /* Japanese Art Watermark - Refined */
        .watermark {
            position: absolute;
            bottom: -50px;
            right: -50px;
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
            width: 400px;
            height: 400px;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden relative">

    <!-- Japanese Art Watermark - Refined Design -->
    <svg class="watermark" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="ink-blur" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="0.5" />
            </filter>
        </defs>

        <!-- Red Sun -->
        <circle cx="220" cy="60" r="35" fill="#C0392B" opacity="0.8" style="mix-blend-mode: multiply;" />

        <!-- Bamboo Stalks -->
        <g stroke="#2C3E50" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.9">
            <path d="M260 300 Q270 200 240 100" stroke-width="4" />
            <path d="M260 300 M262 250 M265 200 M255 150 M245 100" stroke-width="0" />
            <path d="M290 300 Q280 220 295 140" stroke-width="3" />
            <path d="M220 300 Q230 250 210 180" stroke-width="2.5" />
        </g>

        <!-- Bamboo Leaves -->
        <g fill="#2C3E50" opacity="0.9">
            <path d="M240 100 Q220 90 200 105 Q220 100 240 100 Z" />
            <path d="M240 100 Q250 80 230 60 Q245 80 240 100 Z" />
            <path d="M240 150 Q220 145 205 155 Q225 150 240 150 Z" />
            <path d="M295 140 Q275 130 260 135 Q280 135 295 140 Z" />
            <path d="M210 180 Q190 170 175 180 Q195 175 210 180 Z" />
        </g>

        <!-- Pagoda Silhouette -->
        <g stroke="#2C3E50" stroke-width="1.5" fill="none" opacity="0.7" transform="translate(20, 20)">
            <path d="M280 280 L220 280" />
            <path d="M270 260 L230 260" />
            <path d="M260 240 L240 240" />
            <path d="M285 280 L220 280 L215 275" />
            <path d="M275 260 L230 260 L225 255" />
            <path d="M265 240 L240 240 L235 235" />
        </g>
    </svg>

    <!-- Header -->
    <header
        class="bg-white border-b border-[#E2E8F0] px-6 py-4 flex justify-between items-center shadow-sm z-30 relative">
        <div class="flex items-center gap-4">
            <div class="bg-[#4A5568] text-white p-2 rounded-md shadow-sm">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-[#2C3E50] text-xl leading-tight tracking-tight">Planet Editor</h1>
                <p class="text-xs text-[#7F8C8D] font-light tracking-wide uppercase">Rapid Data Entry System</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('fileInput').click()"
                class="btn-outline px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span class="hidden sm:inline">Import Excel</span>
            </button>
            <input type="file" id="fileInput" accept=".xlsx" class="hidden" onchange="handleFileUpload(event)">

            <button onclick="exportToExcel()"
                class="btn-action px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 shadow-sm">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span class="hidden sm:inline">Export File</span>
            </button>
        </div>
    </header>

    <!-- Toolbar -->
    <div
        class="bg-white border-b border-[#E2E8F0] px-6 py-3 flex flex-col sm:flex-row items-start sm:items-center gap-4 overflow-x-auto no-scrollbar z-20 relative">
        <div class="flex items-center gap-1 bg-[#F7FAFC] p-1 rounded-lg shrink-0 border border-[#EDF2F7]">
            <button onclick="setView('table')" id="btn-table"
                class="px-4 py-1.5 rounded-md text-sm font-medium bg-white text-[#4A5568] shadow-sm transition-all border border-[#E2E8F0]">Table</button>
            <button onclick="setView('card')" id="btn-card"
                class="px-4 py-1.5 rounded-md text-sm font-medium text-[#A0AEC0] hover:text-[#4A5568] transition-all">Cards</button>
        </div>

        <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block"></div>

        <!-- Search & Filters -->
        <div class="flex items-center gap-3 w-full sm:w-auto overflow-x-auto">
            <div class="relative">
                <svg class="absolute left-3 top-2 text-[#A0AEC0]" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Search..."
                    class="pl-9 pr-3 py-1.5 text-sm border border-[#E2E8F0] rounded-md focus:border-[#4A5568] outline-none w-32 sm:w-48 bg-[#F9F9F7] focus:bg-white transition-colors">
            </div>

            <select id="filterClass" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Classes</option>
            </select>

            <select id="filterSection" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Sections</option>
            </select>

            <select id="filterHouse" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Houses</option>
            </select>

            <select id="filterGender" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Genders</option>
            </select>

            <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block mx-2"></div>

            <select id="filterItem" onchange="handleItemFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568] max-w-[180px] font-medium">
                <option value="">Filter by Item</option>
            </select>

            <!-- Dynamic Component Filters Container -->
            <div id="dynamicFilters" class="flex items-center gap-2">
                <!-- Dropdowns will be injected here -->
            </div>
        </div>

        <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block"></div>

        <div class="text-sm text-[#7F8C8D] whitespace-nowrap font-light">
            <span id="rowCount" class="font-bold text-[#2C3E50]">0</span> records
        </div>

        <div class="flex items-center gap-2 ml-auto">
            <input type="checkbox" id="showCalculated" checked onchange="renderTable()"
                class="rounded text-[#4A5568] focus:ring-[#4A5568] border-[#CBD5E0]">
            <label for="showCalculated"
                class="text-sm text-[#4A5568] select-none cursor-pointer whitespace-nowrap font-medium">Show
                Calculated</label>
        </div>

        <button onclick="addNewRow()"
            class="text-[#4A5568] hover:bg-[#EDF2F7] px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1 whitespace-nowrap ml-2 transition-colors">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add
        </button>
    </div>

    <!-- Sheet Tabs (Dynamic) -->
    <div id="sheetTabs"
        class="flex gap-2 px-6 py-2 bg-[#F1F5F9] border-b border-[#E2E8F0] overflow-x-auto hidden items-center whitespace-nowrap min-h-[42px]">
        <!-- Sheet buttons will be injected here -->
    </div>

    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative bg-[#F9F9F7]/90 z-10 flex flex-col">

        <!-- Table View -->
        <div id="tableView" class="flex-1 overflow-auto">
            <table class="w-full border-collapse text-sm">
                <thead id="tableHead"
                    class="bg-[#FFFFFF] text-[#7F8C8D] font-medium text-xs uppercase sticky-header shadow-sm tracking-wider">
                    <!-- Headers injected by JS -->
                </thead>
                <tbody id="tableBody" class="bg-white/80 backdrop-blur-sm">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Card View (Mobile) -->
        <div id="cardView" class="hidden flex-1 overflow-auto p-6 space-y-4 pb-24">
            <!-- Cards will be inserted here -->
        </div>

        <!-- Pagination Controls -->
        <div class="bg-white border-t border-[#E2E8F0] px-6 py-3 flex items-center justify-between z-20">
            <div class="flex items-center gap-2">
                <span class="text-xs text-[#7F8C8D]">Rows per page:</span>
                <select id="rowsPerPage" onchange="changeRowsPerPage()"
                    class="text-xs border border-[#E2E8F0] rounded px-2 py-1 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs text-[#7F8C8D]" id="pageInfo">Page 1 of 1</span>
                <div class="flex gap-1">
                    <button onclick="prevPage()"
                        class="p-1 rounded hover:bg-[#F7FAFC] text-[#4A5568] disabled:opacity-50" id="btnPrev">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <button onclick="nextPage()"
                        class="p-1 rounded hover:bg-[#F7FAFC] text-[#4A5568] disabled:opacity-50" id="btnNext">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        let data = [];
        let currentWorkbook = null;
        let currentSheetName = "";
        let currentMetadata = [];

        let filters = {
            search: '',
            class: '',
            section: '',
            house: '',
            gender: '',
            item: '',
            components: {}
        };

        // Pagination State
        let currentPage = 1;
        let rowsPerPage = 50;
        let searchTimeout = null;

        const infoCols = ["S.No", "Admission No", "Student Name", "Class", "Section", "House", "Gender", "Absent/Present"];
        const measureCols = ["U1", "U2", "U3", "U4", "U5", "U6", "U7", "U8", "L1", "L2", "L3", "L4", "L5", "L6", "L7", "L8"];

        // Item Definitions
        const boysItems = [
            { name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" },
        ];

        const girlsItems = [
            { name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" },
            { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" },
            { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" },
            { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" },
        ];

        const allItems = [...boysItems, ...girlsItems];

        function init() {
            const saved = localStorage.getItem('planetEditorData');
            if (saved) {
                data = JSON.parse(saved);
            } else {
                for (let i = 0; i < 5; i++) addNewRow(false);
            }
            populateFilters();
            populateItemFilter();
            renderTable();
            renderCards();
            updateCount();

            // Enter Key Navigation
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && e.target.classList.contains('cell-input')) {
                    e.preventDefault();
                    const inputs = Array.from(document.querySelectorAll('.cell-input'));
                    const index = inputs.indexOf(e.target);
                    if (index > -1 && index < inputs.length - 1) {
                        const nextInput = inputs[index + 1];
                        nextInput.focus();
                        if (nextInput.tagName === 'INPUT' && (nextInput.type === 'text' || nextInput.type === 'number')) {
                            nextInput.select();
                        }
                    } else if (index === inputs.length - 1) {
                        // Optional: Add new row if at the very end?
                        // For now just stop.
                    }
                }
            });
        }

        function populateFilters() {
            const classes = [...new Set(data.map(r => r.Class).filter(Boolean))].sort();
            const sections = [...new Set(data.map(r => r.Section).filter(Boolean))].sort();
            const houses = [...new Set(data.map(r => r.House).filter(Boolean))].sort();
            const genders = [...new Set(data.map(r => r.Gender).filter(Boolean))].sort();

            const classSelect = document.getElementById('filterClass');
            const sectionSelect = document.getElementById('filterSection');
            const houseSelect = document.getElementById('filterHouse');
            const genderSelect = document.getElementById('filterGender');

            const currentClass = classSelect.value;
            const currentSection = sectionSelect.value;
            const currentHouse = houseSelect.value;
            const currentGender = genderSelect.value;

            classSelect.innerHTML = '<option value="">All Classes</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            sectionSelect.innerHTML = '<option value="">All Sections</option>' + sections.map(s => `<option value="${s}">${s}</option>`).join('');
            houseSelect.innerHTML = '<option value="">All Houses</option>' + houses.map(h => `<option value="${h}">${h}</option>`).join('');
            genderSelect.innerHTML = '<option value="">All Genders</option>' + genders.map(g => `<option value="${g}">${g}</option>`).join('');

            if (classes.includes(currentClass)) classSelect.value = currentClass;
            if (sections.includes(currentSection)) sectionSelect.value = currentSection;
            if (houses.includes(currentHouse)) houseSelect.value = currentHouse;
            if (genders.includes(currentGender)) genderSelect.value = currentGender;
        }

        function populateItemFilter() {
            const itemSelect = document.getElementById('filterItem');
            itemSelect.innerHTML = '<option value="">Filter by Item</option>' + allItems.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
        }

        function handleSearch() {
            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filters.search = document.getElementById('searchInput').value.toLowerCase();
                currentPage = 1; // Reset to first page on search
                renderTable();
                renderCards();
                updateCount();
            }, 300);
        }

        function handleFilter() {
            filters.class = document.getElementById('filterClass').value;
            filters.section = document.getElementById('filterSection').value;
            filters.house = document.getElementById('filterHouse').value;
            filters.gender = document.getElementById('filterGender').value;
            currentPage = 1; // Reset to first page on filter
            renderTable();
            renderCards();
            updateCount();
        }

        function handleItemFilter() {
            const itemName = document.getElementById('filterItem').value;
            filters.item = itemName;
            filters.components = {};

            const container = document.getElementById('dynamicFilters');
            container.innerHTML = '';

            if (itemName) {
                const item = allItems.find(i => i.name === itemName);
                if (item) {
                    item.cols.forEach(col => {
                        const values = [...new Set(data.map(r => r[col]).filter(v => v && v !== "00"))].sort();

                        const select = document.createElement('select');
                        select.className = "text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 outline-none focus:border-[#4A5568] bg-white w-20 text-[#4A5568]";
                        select.innerHTML = `<option value="">${col}</option>` + values.map(v => `<option value="${v}">${v}</option>`).join('');

                        select.onchange = (e) => {
                            if (e.target.value) {
                                filters.components[col] = e.target.value;
                            } else {
                                delete filters.components[col];
                            }
                            currentPage = 1;
                            renderTable();
                            renderCards();
                            updateCount();
                        };

                        container.appendChild(select);
                    });
                }
            }

            currentPage = 1;
            renderTable();
            renderCards();
            updateCount();
        }

        function getFilteredData() {
            return data.filter(row => {
                const matchesSearch = !filters.search ||
                    (row["Student Name"] || "").toLowerCase().includes(filters.search) ||
                    (String(row["Admission No"]) || "").toLowerCase().includes(filters.search);

                const matchesClass = !filters.class || row.Class === filters.class;
                const matchesSection = !filters.section || row.Section === filters.section;
                const matchesHouse = !filters.house || row.House === filters.house;
                const matchesGender = !filters.gender || row.Gender === filters.gender;

                let matchesComponents = true;
                if (filters.item) {
                    const item = allItems.find(i => i.name === filters.item);
                    if (item) {
                        const gender = (row["Gender"] || "").toUpperCase();
                        const itemType = item.type.toUpperCase();
                        if (itemType === "MALE" && gender !== "MALE") matchesComponents = false;
                        if (itemType === "FEMALE" && gender !== "FEMALE") matchesComponents = false;
                    }

                    Object.keys(filters.components).forEach(col => {
                        if (row[col] !== filters.components[col]) {
                            matchesComponents = false;
                        }
                    });
                }

                return matchesSearch && matchesClass && matchesSection && matchesHouse && matchesGender && matchesComponents;
            });
        }

        function addNewRow(render = true) {
            const newRow = {};
            [...infoCols, ...measureCols].forEach(col => newRow[col] = "");
            newRow["Absent/Present"] = "Present";
            measureCols.forEach(col => newRow[col] = "00");
            newRow["S.No"] = data.length + 1;

            data.push(newRow);
            if (render) {
                // If adding a row, go to the last page
                const totalFiltered = getFilteredData().length;
                currentPage = Math.ceil(totalFiltered / rowsPerPage);

                populateFilters();
                renderTable();
                renderCards();
                updateCount();
                saveData();

                // Scroll to bottom
                setTimeout(() => {
                    const tableContainer = document.getElementById('tableView');
                    tableContainer.scrollTop = tableContainer.scrollHeight;
                }, 50);
            }
        }

        function updateCell(index, field, value) {
            data[index][field] = value;
            debouncedSave(); // Use debounced save

            // Smart Update: Only re-render if necessary
            // These fields affect filtering or structure, so we MUST re-render/re-filter
            const needsRerender =
                ['Class', 'Section', 'House', 'Gender'].includes(field) ||
                (filters.search && (field === 'Student Name' || field === 'Admission No')) ||
                (filters.item && measureCols.includes(field));

            if (needsRerender) {
                if (['Class', 'Section', 'House', 'Gender'].includes(field)) {
                    populateFilters();
                }

                if (filters.item && measureCols.includes(field)) {
                    const currentSelections = { ...filters.components };
                    handleItemFilter(); // This rebuilds dropdowns
                    const container = document.getElementById('dynamicFilters');
                    Array.from(container.children).forEach(select => {
                        const col = select.options[0].text;
                        if (currentSelections[col]) {
                            select.value = currentSelections[col];
                            if (select.value === currentSelections[col]) {
                                filters.components[col] = currentSelections[col];
                            }
                        }
                    });
                }
                renderTable();
                renderCards();
                updateCount();
            } else {
                // Optimized Path:
                // If we are just editing text/numbers and it doesn't affect filters:
                // 1. We have already updated 'data'.
                // 2. We just need to update the calculated columns if they are visible.
                updateRowCalculations(index);
            }
        }

        function deleteRow(index) {
            if (confirm('Delete this record?')) {
                data.splice(index, 1);
                data.forEach((row, i) => row["S.No"] = i + 1);
                populateFilters();
                renderTable();
                renderCards();
                updateCount();
                saveData();
            }
        }

        function calculateItemValue(row, item) {
            const gender = (row["Gender"] || "").toUpperCase();
            const itemType = item.type.toUpperCase();

            if (itemType === "MALE" && gender !== "MALE") return "";
            if (itemType === "FEMALE" && gender !== "FEMALE") return "";

            const parts = item.cols.map(col => row[col] || "00");
            return parts.join(",");
        }

        // Pagination Logic
        function changeRowsPerPage() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            renderTable();
            renderCards();
            updateCount();
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                renderCards();
                updateCount();
            }
        }

        function nextPage() {
            const filteredData = getFilteredData();
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
                renderCards();
                updateCount();
            }
        }

        function renderTable() {
            const filteredData = getFilteredData();
            const showCalculated = document.getElementById('showCalculated').checked;
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            // Pagination Slice
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            // Render Header
            let headerHTML = `
                <tr>
                    <th class="p-3 border-b border-r border-[#E2E8F0] w-12 text-center bg-[#F9F9F7] sticky-col text-[#A0AEC0]">#</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[120px] text-left bg-[#F9F9F7] sticky-col" style="left: 48px;">Student Name</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[100px] text-left">Gender</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[80px] text-left">Class</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[80px] text-left">Section</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[80px] text-left">House</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[100px] text-left">Adm No</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[120px] text-left">Absent/Present</th>
            `;

            measureCols.forEach(col => {
                const colorClass = col.startsWith('U') ? 'bg-[#EBF8FF] text-[#3182CE]' : 'bg-[#F0FFF4] text-[#38A169]';
                headerHTML += `<th class="p-3 border-b border-r border-[#E2E8F0] ${colorClass} min-w-[60px] text-center font-semibold">${col}</th>`;
            });

            if (showCalculated) {
                allItems.forEach(item => {
                    headerHTML += `<th class="p-3 border-b border-r border-[#E2E8F0] bg-[#FAF5FF] text-[#805AD5] min-w-[150px] text-left whitespace-nowrap text-[10px] font-medium tracking-wide">${item.name.replace('BOYS - ', 'B: ').replace('GIRLS - ', 'G: ')}</th>`;
                });
            }

            headerHTML += `<th class="p-3 border-b border-[#E2E8F0] min-w-[50px]"></th></tr>`;
            thead.innerHTML = headerHTML;

            // Render Body
            tbody.innerHTML = pageData.map((row) => {
                const i = data.indexOf(row); // Get original index

                let rowHTML = `
                <tr class="hover:bg-[#F7FAFC] group border-b border-[#EDF2F7] transition-colors">
                    <td class="p-0 border-r border-[#EDF2F7] sticky-col bg-white group-hover:bg-[#F7FAFC] text-center text-[#CBD5E0] text-xs font-mono">${row["S.No"]}</td>
                    <td class="p-0 border-r border-[#EDF2F7] sticky-col bg-white group-hover:bg-[#F7FAFC]" style="left: 48px;">
                        <input type="text" value="${row["Student Name"] || ''}" onchange="updateCell(${i}, 'Student Name', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-[#2C3E50] font-medium" placeholder="Name">
                    </td>
                    <td class="p-0 border-r border-[#EDF2F7]">
                        <select onchange="updateCell(${i}, 'Gender', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-sm ${row["Gender"]?.toLowerCase() === 'male' ? 'text-blue-600 font-medium' : row["Gender"]?.toLowerCase() === 'female' ? 'text-pink-600 font-medium' : 'text-[#A0AEC0]'}">
                            <option value="" ${!row["Gender"] ? 'selected' : ''}>-</option>
                            <option value="Male" ${row["Gender"] === 'Male' ? 'selected' : ''}>Male</option>
                            <option value="Female" ${row["Gender"] === 'Female' ? 'selected' : ''}>Female</option>
                        </select>
                    </td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["Class"] || ''}" onchange="updateCell(${i}, 'Class', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["Section"] || ''}" onchange="updateCell(${i}, 'Section', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["House"] || ''}" onchange="updateCell(${i}, 'House', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["Admission No"] || ''}" onchange="updateCell(${i}, 'Admission No', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]">
                        <select onchange="updateCell(${i}, 'Absent/Present', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-sm text-[#4A5568]">
                            <option value="Present" ${(!row["Absent/Present"] || row["Absent/Present"] === 'Present') ? 'selected' : ''}>Present</option>
                            <option value="Absent" ${row["Absent/Present"] === 'Absent' ? 'selected' : ''}>Absent</option>
                            <option value="Leave" ${row["Absent/Present"] === 'Leave' ? 'selected' : ''}>Leave</option>
                            <option value="OD" ${row["Absent/Present"] === 'OD' ? 'selected' : ''}>OD</option>
                        </select>
                    </td>
                `;

                measureCols.forEach(col => {
                    const bgClass = col.startsWith('U') ? 'bg-[#EBF8FF]/30' : 'bg-[#F0FFF4]/30';
                    rowHTML += `
                        <td class="p-0 border-r border-[#EDF2F7] ${bgClass}">
                            <input type="text" value="${row[col] || ''}" onfocus="if(this.value==='00') this.select()" onchange="updateCell(${i}, '${col}', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center font-mono text-[#4A5568] focus:bg-white cursor-pointer">
                        </td>
                    `;
                });

                if (showCalculated) {
                    allItems.forEach(item => {
                        const val = calculateItemValue(row, item);
                        rowHTML += `<td class="p-2 border-r border-[#EDF2F7] bg-[#FAF5FF]/30 text-[10px] text-[#805AD5] font-mono whitespace-nowrap overflow-hidden text-ellipsis">${val}</td>`;
                    });
                }

                rowHTML += `
                    <td class="p-1 text-center">
                        <button onclick="deleteRow(${i})" class="text-[#CBD5E0] hover:text-red-500 transition-colors">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </td>
                </tr>`;

                return rowHTML;
            }).join('');
        }

        function renderCards() {
            const filteredData = getFilteredData();

            // Pagination Slice for Cards too
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            const container = document.getElementById('cardView');
            container.innerHTML = pageData.map((row) => {
                const i = data.indexOf(row);
                return `
                <div class="bg-white rounded-lg shadow-sm border border-[#E2E8F0] p-5 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-[#F7FAFC] text-[#A0AEC0] font-bold w-8 h-8 rounded-full flex items-center justify-center text-xs border border-[#EDF2F7]">
                                ${row["S.No"]}
                            </div>
                            <div>
                                <input type="text" value="${row["Student Name"] || ''}" onchange="updateCell(${i}, 'Student Name', this.value)" class="font-bold text-[#2C3E50] border-b border-transparent focus:border-[#4A5568] outline-none bg-transparent w-full text-lg" placeholder="Student Name">
                                <div class="flex gap-2 mt-2">
                                    <select onchange="updateCell(${i}, 'Gender', this.value)" class="text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] text-[#4A5568]">
                                        <option value="" ${!row["Gender"] ? 'selected' : ''}>Gender</option>
                                        <option value="Male" ${row["Gender"] === 'Male' ? 'selected' : ''}>Male</option>
                                        <option value="Female" ${row["Gender"] === 'Female' ? 'selected' : ''}>Female</option>
                                    </select>
                                    <input type="text" value="${row["Class"] || ''}" onchange="updateCell(${i}, 'Class', this.value)" class="text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] w-14 text-center text-[#4A5568]" placeholder="Class">
                                    <input type="text" value="${row["Section"] || ''}" onchange="updateCell(${i}, 'Section', this.value)" class="text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] w-14 text-center text-[#4A5568]" placeholder="Sec">
                                    <input type="text" value="${row["House"] || ''}" onchange="updateCell(${i}, 'House', this.value)" class="text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] w-20 text-center text-[#4A5568]" placeholder="House">
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteRow(${i})" class="text-[#CBD5E0] hover:text-red-500">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-3 mb-2">
                        ${measureCols.map(col => `
                            <div class="relative">
                                <label class="absolute -top-2 left-2 bg-white px-1 text-[10px] font-bold ${col.startsWith('U') ? 'text-[#3182CE]' : 'text-[#38A169]'} tracking-wider">${col}</label>
                                <input type="number" value="${row[col] || ''}" onfocus="if(this.value==='00') this.select()" onchange="updateCell(${i}, '${col}', this.value)" class="w-full border border-[#E2E8F0] rounded-md p-2 text-center font-mono text-sm focus:border-[#4A5568] focus:ring-1 focus:ring-[#4A5568] outline-none text-[#2C3E50]">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `}).join('');
        }

        function setView(view) {
            document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
            document.getElementById('cardView').classList.toggle('hidden', view !== 'card');

            document.getElementById('btn-table').className = view === 'table' ? 'px-4 py-1.5 rounded-md text-sm font-medium bg-white text-[#4A5568] shadow-sm transition-all border border-[#E2E8F0]' : 'px-4 py-1.5 rounded-md text-sm font-medium text-[#A0AEC0] hover:text-[#4A5568] transition-all';
            document.getElementById('btn-card').className = view === 'card' ? 'px-4 py-1.5 rounded-md text-sm font-medium bg-white text-[#4A5568] shadow-sm transition-all border border-[#E2E8F0]' : 'px-4 py-1.5 rounded-md text-sm font-medium text-[#A0AEC0] hover:text-[#4A5568] transition-all';
        }

        function updateCount() {
            const filtered = getFilteredData().length;
            const total = data.length;
            const totalPages = Math.ceil(filtered / rowsPerPage);

            document.getElementById('rowCount').textContent = `${filtered} / ${total}`;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;

            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages || totalPages === 0;
        }

        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const debouncedSave = debounce(saveData, 1000);

        function saveData() {
            localStorage.setItem('planetEditorData', JSON.stringify(data));
        }

        function updateRowCalculations(index) {
            if (!document.getElementById('showCalculated').checked) return;

            // Calculate the actual row index in the current page view
            // The tableBody has the filtered, paged rows.
            // We need to find the DOM row corresponding to 'index' (which is the index in the full 'data' array)
            // However, it's easier to just find the row by its S.No or careful mapping.
            // But wait, 'renderTable' renders `pageData`.
            // Let's interact with the DOM row if it exists in the current view.

            const filteredData = getFilteredData();
            // Check if this data index is in current filtered view
            if (!filteredData.includes(data[index])) return;

            const pageIndex = filteredData.indexOf(data[index]);
            // Check if on current page
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;

            if (pageIndex >= startIndex && pageIndex < endIndex) {
                // It is visible
                const domRowIndex = pageIndex - startIndex;
                const tbody = document.getElementById('tableBody');
                const row = tbody.children[domRowIndex];
                if (!row) return;

                // Calculated columns are at the end.
                // We know how many info + measure columns there are.
                const startCalcIndex = infoCols.length + measureCols.length; // S.No + Info + Measure
                // Actually the DOM structure is: 
                // td (S.No) + td (Name/Inputs...)
                // Let's count properly.
                // S.No (0) + StudentName (1) + Gender (2) + Class (3) + Sec (4) + House (5) + Adm (6) + Abs/Pres (7) = 8 info-blocks?
                // Wait, renderTable uses specific structure.
                // 8 fixed columns (S.No to Absent/Present) + 16 Measure Columns = 24 columns.
                // So calculated columns start at index 24 (0-based) ?
                // Let's verify renderTable loop.

                // Columns:
                // 0: S.No
                // 1: Name
                // 2: Gender
                // 3: Class
                // 4: Sec
                // 5: House
                // 6: Adm
                // 7: Abs/Pres
                // 8..23: Measures (16 cols)
                // 24...: Calculated
                // Last one is Delete button.

                const calcStartIndex = 8 + 16;
                const dataRow = data[index];

                allItems.forEach((item, idx) => {
                    const cell = row.children[calcStartIndex + idx];
                    if (cell) {
                        cell.textContent = calculateItemValue(dataRow, item);
                    }
                });
            }
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const ab = await file.arrayBuffer();
            currentWorkbook = XLSX.read(ab);

            const sheetNames = currentWorkbook.SheetNames;
            renderSheetTabs(sheetNames);
            loadSheet(sheetNames[0]);
        }

        function renderSheetTabs(sheetNames) {
            const container = document.getElementById('sheetTabs');
            if (sheetNames.length <= 1) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            container.innerHTML = `<span class="text-xs font-bold text-[#7F8C8D] uppercase tracking-wider mr-2">Sheets:</span>` +
                sheetNames.map(name => {
                    return `<button onclick="loadSheet('${name}')" data-sheet="${name}" class="sheet-tab px-3 py-1.5 rounded-t-md text-sm font-medium transition-all border-b-2 border-transparent hover:bg-white hover:text-[#2C3E50] text-[#7F8C8D]">${name}</button>`;
                }).join('');
        }

        function loadSheet(sheetName) {
            currentSheetName = sheetName;

            // Update Active Tab UI
            document.querySelectorAll('.sheet-tab').forEach(btn => {
                if (btn.dataset.sheet === sheetName) {
                    btn.classList.add('bg-white', 'text-[#2C3E50]', 'border-[#4A5568]', 'shadow-sm');
                    btn.classList.remove('text-[#7F8C8D]', 'border-transparent');
                } else {
                    btn.classList.remove('bg-white', 'text-[#2C3E50]', 'border-[#4A5568]', 'shadow-sm');
                    btn.classList.add('text-[#7F8C8D]', 'border-transparent');
                }
            });

            const ws = currentWorkbook.Sheets[sheetName];

            // Smart Header Detection (Upgraded from index.html)
            const headerRowIndex = detectHeaderRow(ws);
            console.log("Detected Header Row at Index:", headerRowIndex);

            // Capture Metadata Rows (Rows before the header)
            if (headerRowIndex > 0) {
                const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
                currentMetadata = rawRows.slice(0, headerRowIndex);
                // Ensure empty array if undefined/null
            } else {
                currentMetadata = [];
            }

            const jsonData = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex, defval: "" });

            data = jsonData.map((row, i) => {
                const newRow = {};
                // Normalize keys from import
                const rowKeys = Object.keys(row);

                infoCols.forEach(col => {
                    // Try exact match
                    if (row[col] !== undefined) {
                        newRow[col] = row[col];
                    } else {
                        // Try case-insensitive match
                        const match = rowKeys.find(k => k.trim().toLowerCase() === col.toLowerCase());
                        newRow[col] = match ? row[match] : "";
                    }
                });

                if (!newRow["Absent/Present"]) newRow["Absent/Present"] = "Present";

                // Measure Columns Matching
                // Row keys might be "U1 (Shirt Length)" or just "U1"
                rowKeys.forEach(key => {
                    const cleanKey = key.trim();
                    measureCols.forEach(m => {
                        // Match "U1", "U1 ", "U1 ("
                        if (cleanKey === m || cleanKey.startsWith(m + " ") || cleanKey.startsWith(m + "(")) {
                            newRow[m] = row[key];
                        }
                    });
                });

                measureCols.forEach(m => {
                    if (!newRow[m]) newRow[m] = "00";
                });
                newRow["S.No"] = i + 1;
                return newRow;
            });

            populateFilters();
            populateItemFilter();
            renderTable();
            renderCards();
            updateCount();
            saveData();
        }

        function detectHeaderRow(ws) {
            const keyTerms = [
                "student", "name", "class", "section", "admission", "adm",
                "gender", "house", "u1", "s.no", "sl.no", "std", "div", "sec",
                "roll", "id", "no"
            ];

            const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            let bestIndex = 0;
            let maxMatches = 0;

            // Scan first 20 rows
            for (let i = 0; i < Math.min(rawRows.length, 20); i++) {
                const row = rawRows[i];
                let matches = 0;
                if (Array.isArray(row)) {
                    row.forEach(cell => {
                        if (typeof cell === 'string') {
                            const cellLower = cell.trim().toLowerCase();
                            if (keyTerms.some(term => cellLower.includes(term))) {
                                matches++;
                            }
                        }
                    });
                }
                if (matches > maxMatches) {
                    maxMatches = matches;
                    bestIndex = i;
                }
            }
            return bestIndex;
        }

        function exportToExcel() {
            const exportData = getFilteredData(); // Use filtered data

            const infoHeaders = ["S.No", "Admission No", "Student Name", "Class", "Section", "House", "Gender", "Absent/Present"];
            const measureHeaders = [
                "U1 (SHIRT LENGTH)", "U2 (CHEST)", "U3 (STOMACH)", "U4 (SHOULDER)",
                "U5 (FULL SLEEVE)", "U6 (HALF SLEEVE)", "U7 (KURTHA/SPECIAL FROCK LENGTH)", "U8 (EXTRA CELL)",
                "L1 (PANT LENGTH)", "L2 (WAIST)", "L3 (SHORTS LENGTH)", "L4 (PINOFORE LENGTH)",
                "L5 (SKIRT LENGTH)", "L6 (HIP)", "L7 (THIGH)", "L8 (EXTRA CELL)"
            ];

            const itemHeaders = allItems.map(i => i.name);
            const headers = [...infoHeaders, ...measureHeaders, ...itemHeaders];

            // Metadata handling for Export
            let sheetData = [];
            if (currentMetadata && currentMetadata.length > 0) {
                sheetData = [...currentMetadata, ...sheetData];
                // If metadata exists, maybe add an empty row spacer? 
                // The import logic captured everything before header, so if there was a spacer, it's in currentMetadata.
            }
            sheetData.push(headers);

            exportData.forEach(row => {
                const rowArray = [];
                infoCols.forEach(col => rowArray.push(row[col]));
                measureCols.forEach(col => rowArray.push(row[col]));
                itemHeaders.forEach(() => rowArray.push(""));
                sheetData.push(rowArray);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sheetData);

            const startMeasureCol = infoHeaders.length;
            const uMap = {};
            for (let i = 1; i <= 8; i++) uMap[`U${i}`] = startMeasureCol + i - 1;
            const lMap = {};
            for (let i = 1; i <= 8; i++) lMap[`L${i}`] = startMeasureCol + 8 + i - 1;
            const startItemCol = headers.length - allItems.length;

            for (let r = 0; r < exportData.length; r++) {
                // Adjust rowNum for metadata
                // Excel is 1-based.
                // sheetData has: [Meta1...MetaN, Headers, Row1...]
                // So Headers are at index: currentMetadata.length
                // Row 1 is at index: currentMetadata.length + 1
                // Excel Row for Row 1 is: currentMetadata.length + 1 + 1 (1-based) = currentMetadata.length + 2

                const metaOffset = currentMetadata ? currentMetadata.length : 0;
                const rowNum = r + metaOffset + 2;

                const genderCell = `G${rowNum}`;

                allItems.forEach((item, idx) => {
                    const colIndex = startItemCol + idx;
                    const cellRef = XLSX.utils.encode_cell({ r: rowNum - 1, c: colIndex });

                    const parts = item.cols.map(comp => {
                        let colIdx = -1;
                        if (uMap[comp] !== undefined) colIdx = uMap[comp];
                        else if (lMap[comp] !== undefined) colIdx = lMap[comp];

                        if (colIdx !== -1) {
                            return `${XLSX.utils.encode_col(colIdx)}${rowNum}`;
                        }
                        return null;
                    }).filter(p => p);

                    const concatFormula = parts.join(' & "," & ');
                    let finalFormula = "";

                    if (item.type === "Male") {
                        finalFormula = `IF(UPPER(${genderCell})="MALE", ${concatFormula}, "")`;
                    } else if (item.type === "Female") {
                        finalFormula = `IF(UPPER(${genderCell})="FEMALE", ${concatFormula}, "")`;
                    } else {
                        finalFormula = concatFormula;
                    }

                    const calculatedValue = calculateItemValue(exportData[r], item);

                    if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
                    ws[cellRef].f = finalFormula;
                    ws[cellRef].v = calculatedValue;
                });
            }

            const wscols = headers.map(h => ({ wch: h.length + 5 }));
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "Measurements");

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            const blob = new Blob([s2ab(wbout)], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "PLANETFINAL_Edited.xlsx";
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }

        init();
    </script>
</body>

</html>
