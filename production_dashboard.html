<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dress Production Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>window.jsPDF = window.jspdf.jsPDF;</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9F9F7;
            color: #2C3E50;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Noto Serif JP', serif;
        }

        .tab-active {
            border-bottom: 2px solid #2C3E50;
            color: #2C3E50;
            font-weight: 600;
        }

        .tab-inactive {
            color: #7F8C8D;
        }

        .tab-inactive:hover {
            color: #2C3E50;
        }

        .btn-action {
            background-color: #4A5568;
            color: white;
            transition: all 0.2s;
        }

        .btn-action:hover {
            background-color: #2D3748;
        }

        .btn-primary {
            background-color: #C0392B;
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: #A93226;
        }

        .btn-outline {
            background-color: #FFFFFF;
            border: 1px solid #E2E8F0;
            color: #4A5568;
            transition: all 0.2s;
        }

        .btn-outline:hover {
            background-color: #F7FAFC;
            border-color: #CBD5E0;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden bg-[#F9F9F7]">

    <!-- Header -->
    <header
        class="bg-white border-b border-[#E2E8F0] px-6 py-3 flex justify-between items-center shadow-sm z-30 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-[#C0392B] to-[#922B21] text-white p-2 rounded-md shadow-sm">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.38 3.4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2 2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2z" />
                    <path d="M9 2v2" />
                    <path d="M9 10v2" />
                    <path d="M9 18v2" />
                    <path d="M15 10v2" />
                    <path d="M15 18v2" />
                    <path d="M15 2v2" />
                    <path d="M3.62 3.4a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2z" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold text-[#2D3748]">Production Dashboard</h1>
                <p class="text-xs text-[#7F8C8D] uppercase tracking-wide">Dress Planning & Grouping</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="index.html"
                class="text-xs font-bold text-gray-500 hover:text-gray-800 uppercase tracking-wide mr-2">
                &larr; Go to Cutting Dashboard
            </a>
            <div class="flex items-center gap-2 border-r border-gray-300 pr-3 mr-1">
                <span id="historyCount" class="text-[10px] font-mono text-gray-400 font-bold mr-1">H:0</span>
                <button onclick="undo()" title="Undo (Ctrl+Z)" class="p-1 hover:bg-gray-100 rounded text-gray-600">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6" />
                        <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" />
                    </svg>
                </button>
                <button onclick="redo()" title="Redo (Ctrl+Y)" class="p-1 hover:bg-gray-100 rounded text-gray-600">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6" />
                        <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13" />
                    </svg>
                </button>
            </div>
            <button onclick="clearSystem()"
                class="text-red-500 hover:text-red-700 text-xs font-bold uppercase transition-colors">Reset
                System</button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-white border-b border-[#E2E8F0] px-6 flex items-center gap-6 overflow-x-auto shrink-0 z-20">
        <button onclick="switchTab('config')" id="tab-config"
            class="tab-active py-3 text-sm transition-colors whitespace-nowrap">1. Configuration</button>
        <button onclick="switchTab('data')" id="tab-data"
            class="tab-inactive py-3 text-sm transition-colors whitespace-nowrap">2. Data & Assignment</button>
        <button onclick="switchTab('groups')" id="tab-groups"
            class="tab-inactive py-3 text-sm transition-colors whitespace-nowrap">3. AI Grouping</button>
        <button onclick="switchTab('reports')" id="tab-reports"
            class="tab-inactive py-3 text-sm transition-colors whitespace-nowrap">4. Reports & Export</button>
        <button onclick="switchTab('analysis')" id="tab-analysis"
            class="tab-inactive py-3 text-sm transition-colors whitespace-nowrap text-purple-600 font-bold">5. Smart
            Analysis ✨</button>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-hidden relative">

        <!-- MODULE 1: CONFIGURATION -->
        <div id="view-config" class="h-full w-full overflow-y-auto p-6 absolute inset-0 bg-[#F9F9F7] animate-enter">
            <div class="max-w-5xl mx-auto space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold text-[#2C3E50]">Dress Configuration</h2>
                        <p class="text-xs text-gray-500">Define dress types and their measurements.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="restoreDefaultDresses()"
                            class="btn-outline px-4 py-2 rounded shadow text-sm font-medium"
                            title="Load standard 24 school uniforms">Load Defaults</button>
                        <button onclick="openDressModal()"
                            class="btn-action px-4 py-2 rounded shadow text-sm font-medium">+ Add New Dress
                            Type</button>
                    </div>
                </div>

                <!-- Dress List -->
                <div id="dressList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Dynamic Dress Cards -->
                </div>
            </div>
        </div>

        <!-- MODULE 2: DATA & ASSIGNMENT -->
        <div id="view-data"
            class="h-full w-full flex flex-col absolute inset-0 translate-x-full transition-transform duration-300 bg-[#F9F9F7]">
            <!-- Toolbar -->
            <div
                class="bg-white border-b border-[#E2E8F0] px-6 py-3 flex gap-3 items-center shrink-0 overflow-x-auto shadow-sm">
                <button onclick="document.getElementById('fileInput').click()"
                    class="btn-outline px-3 py-1.5 rounded text-sm font-medium flex items-center gap-2 whitespace-nowrap">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    Import Students
                </button>

                <div class="h-6 w-px bg-gray-300 mx-2"></div>

                <!-- Filters -->
                <input type="text" id="searchInput" placeholder="Search..."
                    class="text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 focus:border-blue-500 outline-none w-24"
                    onkeyup="renderStudentTable()">
                <input type="text" id="filterClassInput" placeholder="Class (e.g. 1, 2, 5A)"
                    class="text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 focus:border-blue-500 outline-none w-40"
                    onkeyup="renderStudentTable()">
                <select id="filterHouse" class="text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 bg-white">
                    <option value="">House: All</option>
                </select>
                <select id="filterGender" class="text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 bg-white">
                    <option value="">Gender: All</option>
                </select>

                <div class="flex-1"></div>

                <div class="flex items-center gap-2">
                    <!-- Quick Assign (Old Way) -->
                    <select id="assignDressSelect"
                        class="text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 bg-white w-32">
                        <option value="">Select Dress...</option>
                    </select>
                    <button onclick="assignDressQuick()" id="btnAssignQuick"
                        class="btn-primary px-3 py-1.5 rounded-md text-sm font-bold shadow-sm whitespace-nowrap"
                        title="Assign 1 item to selected students immediately">
                        Assign
                    </button>

                    <div class="h-6 w-px bg-gray-300 mx-1"></div>

                    <!-- Quantity Assign (New Way) -->
                    <button onclick="openAssignmentModal()"
                        class="px-3 py-1.5 rounded-md text-sm font-bold text-blue-600 bg-blue-50 border border-blue-200 hover:bg-blue-100 whitespace-nowrap">
                        Assign w/ Qty...
                    </button>
                </div>
            </div>

            <!-- Data Table -->
            <div class="flex-1 overflow-auto p-6">
                <div class="bg-white rounded-lg shadow-sm border border-[#E2E8F0] overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead
                            class="bg-gray-50 text-gray-600 font-bold sticky top-0 uppercase text-xs tracking-wider border-b border-[#E2E8F0]">
                            <tr>
                                <th class="p-3">Roll No</th>
                                <th class="p-3">Student Name</th>
                                <th class="p-3">Class & Sec</th>
                                <th class="p-3">Gender</th>
                                <th class="p-3 text-blue-700">Assigned Dress</th>
                                <th class="p-3 text-purple-700">Measurements</th>
                            </tr>
                        </thead>
                        <tbody id="studentTable" class="divide-y divide-gray-100 bg-white">
                            <tr>
                                <td colspan="6" class="p-8 text-center text-gray-400 italic">No data imported. Upload an
                                    Excel file.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="px-6 py-2 bg-white border-t border-[#E2E8F0] text-xs text-gray-500 flex justify-between">
                <span id="recordCount">0 Students</span>
            </div>
        </div>

        <!-- MODULE 3: AI GROUPING -->
        <div id="view-groups"
            class="h-full w-full absolute inset-0 translate-x-full transition-transform duration-300 bg-[#F9F9F7] flex flex-col">
            <div class="bg-white border-b border-[#E2E8F0] px-6 py-3 flex justify-between items-center shrink-0">
                <div>
                    <h2 class="text-lg font-bold text-[#2C3E50]">Smart Grouping</h2>
                    <p class="text-xs text-gray-500">Auto-create production batches.</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="document.getElementById('aiConfigPanel').classList.toggle('hidden')"
                        class="text-gray-400 hover:text-[#2C3E50] border border-transparent hover:border-[#E2E8F0] p-1.5 rounded transition-all"
                        title="Tune Logic">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                    </button>
                    <div class="h-6 w-px bg-[#E2E8F0] mx-1"></div>
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col items-end">
                            <select id="groupingScope"
                                class="text-xs border border-[#E2E8F0] rounded px-2 py-1 bg-white outline-none focus:border-blue-500 font-bold text-[#2C3E50]"
                                onchange="updateScopeDisplay()">
                                <option value="all">Analyze: All Students</option>
                                <option value="filtered">Analyze: Currently Filtered</option>
                            </select>
                            <span id="scopeFilterSummary" class="text-[10px] text-gray-400 hidden">All data
                                included</span>
                        </div>
                        <button onclick="openManualGroupModal()"
                            class="px-4 py-2 rounded text-sm font-bold bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 shadow-sm flex items-center gap-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 5v14M5 12h14" />
                            </svg>
                            Manual Create
                        </button>
                        <button onclick="runAutoGrouping()"
                            class="btn-action px-4 py-2 rounded text-sm font-bold shadow flex items-center gap-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                                </path>
                            </svg>
                            Run AI Auto-Analysis
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tuning Config Panel -->
            <div id="aiConfigPanel" class="hidden bg-[#F1F5F9] border-b border-[#E2E8F0] px-6 py-4 shadow-inner">
                <div class="flex items-start gap-8">
                    <div>
                        <h4 class="text-xs font-bold text-[#2C3E50] uppercase tracking-wider mb-2">Group Split Logic
                        </h4>
                        <div class="flex gap-4">
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-gray-200">
                                <input type="checkbox" id="cfgSplitClass" checked class="accent-[#2C3E50]">
                                <span class="text-xs font-bold text-gray-600">Class</span>
                            </label>
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-gray-200">
                                <input type="checkbox" id="cfgSplitSection" checked class="accent-[#2C3E50]">
                                <span class="text-xs font-bold text-gray-600">Section</span>
                            </label>
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-gray-200">
                                <input type="checkbox" id="cfgSplitGender" checked class="accent-[#2C3E50]">
                                <span class="text-xs font-bold text-gray-600">Gender</span>
                            </label>
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-gray-200">
                                <input type="checkbox" id="cfgSplitHouse" class="accent-[#2C3E50]">
                                <span class="text-xs font-bold text-gray-600">House</span>
                            </label>
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-gray-200"
                                title="Separate batches for each unique size combination">
                                <input type="checkbox" id="cfgSplitMeasure" class="accent-[#2C3E50]">
                                <span class="text-xs font-bold text-gray-600">Measurements</span>
                            </label>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2">Uncheck to merge groups (e.g. merge all Sections into
                            one Class batch).</p>
                    </div>
                </div>
            </div>

            <div class="px-6 py-2 bg-white border-b border-[#E2E8F0] flex gap-3 shadow-sm items-center">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Filter Groups:</span>
                <select id="filterGroupDress"
                    class="text-xs border border-[#E2E8F0] rounded px-2 py-1.5 bg-gray-50 outline-none hover:border-blue-400 focus:border-blue-500 w-48"
                    onchange="renderGroups()">
                    <option value="">All Dresses</option>
                </select>
                <input type="text" id="filterGroupClass" placeholder="Class (e.g. 1 A)"
                    class="text-xs border border-[#E2E8F0] rounded px-2 py-1.5 bg-gray-50 outline-none hover:border-blue-400 focus:border-blue-500 w-32"
                    onkeyup="renderGroups()">
                <select id="filterGroupGender"
                    class="text-xs border border-[#E2E8F0] rounded px-2 py-1.5 bg-gray-50 outline-none hover:border-blue-400 focus:border-blue-500 w-32"
                    onchange="renderGroups()">
                    <option value="">All Genders</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>

            <div id="groupsContainer" class="flex-1 overflow-auto p-6 flex flex-wrap content-start gap-4">
                <!-- Groups Render Here -->
            </div>
        </div>

        <!-- MODULE 4: REPORTS -->
        <div id="view-reports"
            class="h-full w-full absolute inset-0 translate-x-full transition-transform duration-300 bg-[#F9F9F7] p-6 flex items-center justify-center">
            <div
                class="max-w-2xl w-full bg-white rounded-lg shadow-md border border-[#E2E8F0] p-8 text-center space-y-6">
                <div class="bg-green-50 text-green-700 p-4 rounded-full inline-block">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-[#2C3E50] mb-2">Ready for Production?</h2>
                    <p class="text-gray-500">Export your optimized cutting plans and student lists.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto mt-4">
                    <button onclick="exportFullExcel()"
                        class="bg-white border hover:bg-green-50 hover:border-green-200 border-[#E2E8F0] p-5 rounded-lg text-left group transition-all">
                        <span class="block font-bold text-[#2C3E50] group-hover:text-green-700 mb-1">Master Excel
                            File</span>
                        <span class="text-xs text-gray-500">Full dataset, groups & metadata</span>
                    </button>

                    <button onclick="exportGroupPDFs()"
                        class="bg-white border hover:bg-red-50 hover:border-red-200 border-[#E2E8F0] p-5 rounded-lg text-left group transition-all">
                        <span class="block font-bold text-[#2C3E50] group-hover:text-red-700 mb-1">Group Summary
                            PDF</span>
                        <span class="text-xs text-gray-500">Printable cutting cards</span>
                    </button>

                    <button onclick="triggerImport()"
                        class="bg-white border hover:bg-purple-50 hover:border-purple-200 border-[#E2E8F0] p-5 rounded-lg text-left group transition-all">
                        <span class="block font-bold text-[#2C3E50] group-hover:text-purple-700 mb-1">Restore
                            System</span>
                        <span class="text-xs text-gray-500">Load from Master Excel</span>
                    </button>
                </div>
                <input type="file" id="importInput" accept=".xlsx" class="hidden"
                    onchange="importSystemFromExcel(this)" />
            </div>
        </div>

        <!-- MODULE 5: SMART INSIGHT DASHBOARD -->
        <div id="view-analysis"
            class="h-full w-full overflow-y-auto p-6 absolute inset-0 bg-[#F9F9F7] opacity-0 transition-all duration-300 transform translate-x-full">
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- Header -->
                <div>
                    <h2 class="text-2xl font-bold text-[#2C3E50]">Smart Insight Dashboard</h2>
                    <p class="text-gray-500">Real-time production metrics, fabric calculation, and AI anomaly detection.
                    </p>
                </div>

                <!-- 1. Production Overview Charts -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-[#E2E8F0]">
                    <h3 class="text-lg font-bold text-[#2C3E50] mb-4">Production Overview</h3>
                    <div id="analysisCharts" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Chart Content Injected via JS -->
                        <div class="h-40 bg-gray-50 rounded flex items-center justify-center text-gray-400">Loading
                            Charts...</div>
                    </div>
                </div>

                <!-- 2. Fabric Calculator -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-[#E2E8F0]">
                    <h3 class="text-lg font-bold text-[#2C3E50] mb-2">Fabric Requirements Calculator</h3>
                    <p class="text-xs text-gray-400 mb-4">Enter average consumption per dress type to estimate total
                        fabric
                        vs student count.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 border-b">
                                <tr>
                                    <th class="p-3">Dress Type</th>
                                    <th class="p-3">Count</th>
                                    <th class="p-3">Avg Consumption (Meters)</th>
                                    <th class="p-3 text-right">Total Meters</th>
                                </tr>
                            </thead>
                            <tbody id="fabricCalcTable">
                                <!-- JS Injection -->
                            </tbody>
                            <tfoot class="bg-gray-50 font-bold text-[#2C3E50]">
                                <tr>
                                    <td class="p-3" colspan="3">Grand Total</td>
                                    <td class="p-3 text-right" id="fabricGrandTotal">0 M</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- 3. Anomaly Detection -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-red-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-[#C0392B] mb-1">⚠️ Measurement Anomalies</h3>
                            <p class="text-xs text-gray-500">AI detected potential data entry errors or outliers (> 2
                                Standard Deviations).</p>
                        </div>
                        <button onclick="renderAnalysis()"
                            class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">Refresh Scan</button>
                    </div>

                    <div id="anomalyList" class="mt-4 space-y-2 max-h-60 overflow-y-auto">
                        <!-- JS Injection -->
                        <p class="text-sm text-gray-400 italic">No anomalies detected.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    </main>

    <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(event)" />

    <!-- Dress Config Modal -->
    <div id="dressModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md animate-in fade-in zoom-in duration-200">
            <div class="p-5 border-b border-[#E2E8F0] bg-[#F9F9F7] flex justify-between items-center">
                <h3 class="font-bold text-[#2C3E50] text-lg">Configure Dress</h3>
                <button onclick="document.getElementById('dressModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Dress Name</label>
                    <input type="text" id="dressNameInput"
                        class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none"
                        placeholder="e.g. Regular Shirt">
                </div>

                <div>
                    <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Active Measurements</label>
                    <div class="grid grid-cols-4 gap-2 border border-[#E2E8F0] p-2 rounded bg-gray-50 max-h-40 overflow-y-auto"
                        id="colSelection">
                        <!-- U1-U8, L1-L8 injected js -->
                    </div>
                </div>
            </div>
            <div class="p-4 bg-[#F9F9F7] border-t border-[#E2E8F0] flex justify-end gap-3">
                <button onclick="document.getElementById('dressModal').classList.add('hidden')"
                    class="btn-outline px-4 py-2 rounded text-sm">Cancel</button>
                <button onclick="saveDress()" class="btn-action px-4 py-2 rounded text-sm font-bold shadow-sm">Save
                    Configuration</button>
            </div>
        </div>
    </div>

    <script>
        // --- CORE STATE ---
        let state = {
            dresses: [], // { id, name, cols: ['U1'] }
            students: [], // Raw imported data
            assignments: {}, // studentId -> dressId
            groups: [] // { id, name, studentIds: [], meta: {} }
        };
        let currentGroupId = null; // Global Tracker for active modal group

        // --- UNDO/REDO SYS (Persistent) ---
        const HISTORY_KEY = 'dress_production_history';
        const REDO_KEY = 'dress_production_redo';
        const MAX_HISTORY = 10; // Limit depth to avoid storage quota issues

        let historyStack = [];
        let redoStack = [];

        function updateHistoryUI() {
            const el = document.getElementById('historyCount');
            if (el) el.innerText = `H:${historyStack.length}`;
        }

        function pushHistory() {
            try {
                if (historyStack.length >= MAX_HISTORY) historyStack.shift();

                // Deep Check for Serializability
                const snapshot = JSON.stringify(state);
                historyStack.push(snapshot);
                redoStack = [];

                updateHistoryUI(); // Update UI immediately

                // Persist - Simplified catch
                try {
                    sessionStorage.setItem(HISTORY_KEY, JSON.stringify(historyStack));
                    sessionStorage.removeItem(REDO_KEY);
                } catch (e) {
                    // console.warn("Storage Quota Exception");
                }
            } catch (e) {
                alert("Critical Error: Unable to save undo state! " + e.message);
                console.error(e);
            }
        }

        function undo() {
            if (historyStack.length === 0) return alert("Nothing to undo");
            try {
                redoStack.push(JSON.stringify(state));
                const prev = historyStack.pop();
                state = JSON.parse(prev);
                saveSystem(true);
                refreshAll();
                updateHistoryUI();

                // Persist
                try {
                    sessionStorage.setItem(HISTORY_KEY, JSON.stringify(historyStack));
                    sessionStorage.setItem(REDO_KEY, JSON.stringify(redoStack));
                } catch (e) { }
            } catch (e) { alert("Undo Failed: " + e.message); }
        }

        function redo() {
            if (redoStack.length === 0) return alert("Nothing to redo");
            try {
                historyStack.push(JSON.stringify(state));
                const next = redoStack.pop();
                state = JSON.parse(next);
                saveSystem(true);
                refreshAll();
                updateHistoryUI();

                // Persist
                try {
                    sessionStorage.setItem(HISTORY_KEY, JSON.stringify(historyStack));
                    sessionStorage.setItem(REDO_KEY, JSON.stringify(redoStack));
                } catch (e) { }
            } catch (e) { alert("Redo Failed: " + e.message); }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        function refreshAll() {
            renderDresses();
            renderStudentTable();
            if (state.students.length > 0) populateFilters();
            updateDressDropdowns();
            updateHistoryUI();
        }

        const KEY = 'dress_production_system';
        // Comprehensive Default List from Pattern Dashboard
        const DEFAULT_DRESSES = [
            { id: 'd_def_b1', name: 'BOYS - FORMAL SHIRT', cols: ["U1", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_b2', name: 'BOYS - TRACK T-SHIRT', cols: ["U1", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_b3', name: 'BOYS - UNIFORM T-SHIRT', cols: ["U1", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_b4', name: 'BOYS - JERKIN', cols: ["U1", "U2", "U3", "U4", "U5"] },
            { id: 'd_def_b5', name: 'BOYS - PULLOVER', cols: ["U1", "U2", "U3", "U4", "U5"] },
            { id: 'd_def_b6', name: 'BOYS - FORMAL PANT', cols: ["L1", "L2"] },
            { id: 'd_def_b7', name: 'BOYS - TRACK PANT', cols: ["L1", "L2"] },
            { id: 'd_def_b8', name: 'BOYS - FORMAL SHORTS', cols: ["L3", "L2"] },
            { id: 'd_def_b9', name: 'BOYS - TRACK SHORTS', cols: ["L3", "L2"] },
            { id: 'd_def_b10', name: 'BOYS - PANT SPECIAL CASE', cols: ["L1", "L2", "L6", "L7"] },
            { id: 'd_def_g1', name: 'GIRLS - FORMAL SHIRT', cols: ["U1", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_g2', name: 'GIRLS - TRACK T-SHIRT', cols: ["U1", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_g3', name: 'GIRLS - UNIFORM T-SHIRT', cols: ["U1", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_g4', name: 'GIRLS - JERKIN', cols: ["U1", "U2", "U3", "U4", "U5"] },
            { id: 'd_def_g5', name: 'GIRLS - FULL SLEEVE SHIRT', cols: ["U1", "U2", "U3", "U4", "U5"] },
            { id: 'd_def_g6', name: 'GIRLS - PULLOVER', cols: ["U1", "U2", "U3", "U4", "U5"] },
            { id: 'd_def_g7', name: 'GIRLS - KURTHA SHIRT', cols: ["U7", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_g8', name: 'GIRLS - SPECIAL FROCKS', cols: ["U7", "U2", "U3", "U4", "U6"] },
            { id: 'd_def_g9', name: 'GIRLS - FORMAL PANT', cols: ["L1", "L2"] },
            { id: 'd_def_g10', name: 'GIRLS - TRACK PANT', cols: ["L1", "L2"] },
            { id: 'd_def_g11', name: 'GIRLS - TRACK SHORTS', cols: ["L3", "L2"] },
            { id: 'd_def_g12', name: 'GIRLS - PINOFORE', cols: ["L4", "L2"] },
            { id: 'd_def_g13', name: 'GIRLS - SKIRT', cols: ["L5", "L2"] },
            { id: 'd_def_g14', name: 'GIRLS - PANT SPECIAL CASE', cols: ["L1", "L2", "L6", "L7"] }
        ];

        // --- PERSISTENCE ---
        function saveSystem(skipHistory = false) {
            try {
                localStorage.setItem(KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Save Failed:", e);
                alert("System Save Failed! LocalStorage might be full. Clear some data.");
            }
        }

        function loadSystem() {
            const s = localStorage.getItem(KEY);
            if (s) {
                state = JSON.parse(s);
                if (!state.dresses || state.dresses.length === 0) {
                    state.dresses = [...DEFAULT_DRESSES];
                    saveSystem(true);
                }
            } else {
                state.dresses = [...DEFAULT_DRESSES];
                saveSystem(true);
            }

            // --- DATA MIGRATION: Single Assignment -> Multi Assignment (Array) ---
            if (state.assignments) {
                let migrated = false;
                Object.keys(state.assignments).forEach(sid => {
                    const val = state.assignments[sid];
                    if (val && !Array.isArray(val)) {
                        state.assignments[sid] = [val]; // Wrap in array
                        migrated = true;
                    }
                });
                if (migrated) saveSystem(true);
            }

            // Restore History from Session
            try {
                const h = sessionStorage.getItem(HISTORY_KEY);
                if (h) historyStack = JSON.parse(h);
                const r = sessionStorage.getItem(REDO_KEY);
                if (r) redoStack = JSON.parse(r);
            } catch (e) { console.error("History Restore Error", e); }

            refreshAll();
        }

        // --- RESTORE DEFAULTS FUNCTION ---
        function restoreDefaultDresses() {
            if (confirm("Add all standard 24 school uniforms to your list? This will NOT delete existing data.")) {
                pushHistory(); // SNAPSHOT
                // Add only ones that don't exist by name
                let added = 0;
                DEFAULT_DRESSES.forEach(def => {
                    if (!state.dresses.some(d => d.name === def.name)) {
                        state.dresses.push({ ...def, id: 'd_' + Date.now() + Math.random() });
                        added++;
                    }
                });
                saveSystem();
                renderDresses();
                updateDressDropdowns();
                alert(`Added ${added} new default dress types.`);
            }
        }

        function clearSystem() {
            if (confirm("Factory Reset: Clear ALL System Data? This cannot be undone by simple Undo.")) {
                // Technically we could allow undo if we push history first, but factory reset usually implies nuke.
                // Let's enable undo for safety!
                pushHistory();
                state = { dresses: [...DEFAULT_DRESSES], students: [], assignments: {}, groups: [] };
                saveSystem();
                location.reload();
            }
        }

        // --- TABS ---
        // --- TABS ---
        function switchTab(tabId) {
            // Persist Tab
            sessionStorage.setItem('activeTab', tabId);

            ['config', 'data', 'groups', 'reports', 'analysis'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const view = document.getElementById(`view-${t}`);
                if (t === tabId) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                    view.style.transform = "translateX(0)";
                    view.style.position = "relative";
                    view.classList.remove('opacity-0');
                    if (tabId === 'analysis') renderAnalysis();
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive');
                    view.style.transform = "translateX(100%)";
                    view.style.position = "absolute";
                    view.classList.add('opacity-0');
                }
            });
            if (tabId === 'data') renderStudentTable();
            if (tabId === 'groups') {
                renderGroups();
                if (typeof updateScopeDisplay === 'function') updateScopeDisplay();
            }
        }

        // --- MODULE 1: DRESS CONFIG ---
        function renderDresses() {
            const list = document.getElementById('dressList');

            const cardHTML = state.dresses.map(d => `
                <div class="bg-white p-5 rounded shadow-sm border border-[#E2E8F0] hover:shadow-md transition-shadow relative group">
                    <button onclick="deleteDress('${d.id}')" class="absolute top-3 right-3 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1" title="Delete">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                    <div class="w-8 h-8 bg-gray-100 text-[#2C3E50] rounded flex items-center justify-center mb-3">
                        <span class="font-serif font-bold">${d.name.charAt(0)}</span>
                    </div>
                    <h3 class="font-bold text-lg text-[#2C3E50] mb-2">${d.name}</h3>
                    <div>
                        <p class="text-[10px] font-bold text-[#7F8C8D] uppercase tracking-wider mb-1">Measurements</p>
                        <div class="flex flex-wrap gap-1">
                            ${d.cols.map(c => `<span class="bg-gray-50 text-gray-600 text-[10px] font-mono font-bold px-1.5 py-0.5 rounded border border-[#E2E8F0]">${c}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');

            list.innerHTML = cardHTML + `
             <button onclick="openDressModal()" class="border-2 border-dashed border-[#CBD5E0] rounded p-6 flex flex-col items-center justify-center text-gray-400 hover:bg-white hover:border-[#A0AEC0] hover:text-[#4A5568] transition-colors min-h-[180px]">
                <span class="text-2xl mb-1">+</span>
                <span class="font-semibold text-sm">Add New Type</span>
            </button>`;
        }

        function openDressModal() {
            document.getElementById('dressNameInput').value = '';
            const cols = ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'L1', 'L2', 'L3', 'L4', 'L5', 'L6', 'L7', 'L8'];
            document.getElementById('colSelection').innerHTML = cols.map(c => `
                <label class="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded">
                    <input type="checkbox" value="${c}" class="col-check w-3 h-3 text-blue-600 rounded border-gray-300">
                    <span class="text-xs font-mono font-bold text-gray-700">${c}</span>
                </label>
            `).join('');
            document.getElementById('dressModal').classList.remove('hidden');
        }

        function assignDressToFiltered() {
            const dressId = document.getElementById('assignDressSelect').value;
            if (!dressId) return alert("Please select a Dress Type first.");

            // Prioritize manually selected students
            let targetIds = [...selectedStudentIds];

            // If no manual selection, fallback to ALL filtered?
            // The user asked for "Select All", so explicit selection is better.
            if (targetIds.length === 0) {
                if (!confirm("No specific rows selected. Assign to ALL currently filtered students?")) return;
                const filtered = getFilteredStudents();
                if (filtered.length === 0) return alert("No students to assign.");
                targetIds = filtered.map(s => s.id);
            }

            if (confirm(`Add this dress to ${targetIds.length} students?`)) {
                pushHistory();
                targetIds.forEach(sid => {
                    if (!state.assignments[sid]) state.assignments[sid] = [];
                    // Avoid duplicates
                    if (!state.assignments[sid].some(a => a.dressId === dressId)) {
                        state.assignments[sid].push({ dressId: dressId, assignedAt: Date.now() });
                    }
                });
                saveSystem();
                renderStudentTable();
                alert("Cart Updated: Dress added to students!");
                selectedStudentIds.clear(); // Clear selection after action
                renderStudentTable();
            }
        }

        // --- MODULE 2: DATA & IMPORT ---
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1 });

                let headerRowIndex = 0;
                let maxCols = 0;
                rawRows.forEach((row, i) => {
                    const filled = row.filter(c => c !== undefined && c !== null && c !== '').length;
                    if (filled > maxCols) { maxCols = filled; headerRowIndex = i; }
                });

                const headerRow = rawRows[headerRowIndex].map(h => h ? h.toString().trim() : '');
                const dataRows = rawRows.slice(headerRowIndex + 1);

                const colMap = {};
                ['Roll No', 'Student Name', 'Class', 'Section', 'House', 'Gender'].forEach(key => {
                    const idx = headerRow.findIndex(h => h.toLowerCase().includes(key.toLowerCase()));
                    if (idx !== -1) colMap[key] = idx;
                });

                ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'L1', 'L2', 'L3', 'L4', 'L5', 'L6', 'L7', 'L8'].forEach(m => {
                    // Match "U1" exactly OR "U1 " (prefix) 
                    // This handles "U1", "u1", "U1 (SHIRT LENGTH)", etc.
                    const idx = headerRow.findIndex(h => {
                        const cell = h.toString().toUpperCase().trim();
                        return cell === m || cell.startsWith(m + ' ') || cell.startsWith(m + '(');
                    });
                    if (idx !== -1) colMap[m] = idx;
                });

                pushHistory(); // Capture state before processing import
                state.students = dataRows.map((r, i) => {
                    if (!r[colMap['Student Name']]) return null;
                    const student = {
                        id: 's_' + Date.now() + '_' + i,
                        Roll: r[colMap['Roll No']] || '',
                        Name: r[colMap['Student Name']] || '',
                        Class: r[colMap['Class']] || '',
                        Section: r[colMap['Section']] || '',
                        House: r[colMap['House']] || '',
                        Gender: r[colMap['Gender']] || '',
                    };
                    ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'L1', 'L2', 'L3', 'L4', 'L5', 'L6', 'L7', 'L8'].forEach(m => {
                        student[m] = colMap[m] !== undefined ? (r[colMap[m]] || '') : '';
                    });
                    return student;
                }).filter(s => s !== null);

                saveSystem();
                renderStudentTable();
                populateFilters();
                alert(`Imported ${state.students.length} students!`);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- HELPER FOR SAVING DRESS ---
        function saveDress() {
            const name = document.getElementById('dressNameInput').value;
            if (!name) return alert("Please enter a dress name");
            const checks = document.querySelectorAll('.col-check:checked');
            const cols = Array.from(checks).map(c => c.value);
            if (cols.length === 0) return alert("Select at least one measurement column");

            pushHistory(); // Capture before adding dress
            state.dresses.push({ id: 'd_' + Date.now(), name, cols });
            saveSystem();
            renderDresses();
            updateDressDropdowns();
            document.getElementById('dressModal').classList.add('hidden');
        }

        function deleteDress(id) {
            if (confirm("Delete this dress type?")) {
                pushHistory(); // Capture before delete
                state.dresses = state.dresses.filter(d => d.id !== id);
                saveSystem();
                renderDresses();
                updateDressDropdowns();
            }
        }

        function updateDressDropdowns() {
            const list = state.dresses.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

            // 1. Toolbar Select
            const sel1 = document.getElementById('assignDressSelect');
            if (sel1) sel1.innerHTML = `<option value="">Select Dress...</option>` + list;

            // 2. Modal Select
            const sel2 = document.getElementById('modalAssignDress');
            if (sel2) sel2.innerHTML = `<option value="">Select Dress...</option>` + list;

            // 3. Manual Group Select
            const sel3 = document.getElementById('manualGroupDress');
            if (sel3) sel3.innerHTML = `<option value="">Select Dress...</option>` + list;
        }

        // --- FILTER & RENDER LOGIC ---
        let selectedStudentIds = new Set();
        let sortedClasses = []; // Cache to determine order

        function populateFilters() {
            // Populate House and Gender Dropdowns
            // No need to populate Class dropdowns/ranges as it is now manual input
            const houses = [...new Set(state.students.map(s => s.House))].filter(Boolean).sort();
            const genders = [...new Set(state.students.map(s => s.Gender))].filter(Boolean).sort();

            const hSel = document.getElementById('filterHouse');
            hSel.innerHTML = `<option value="">House: All</option>` + houses.map(h => `<option value="${h}">${h}</option>`).join('');
            hSel.onchange = renderStudentTable;

            const gSel = document.getElementById('filterGender');
            gSel.innerHTML = `<option value="">Gender: All</option>` + genders.map(g => `<option value="${g}">${g}</option>`).join('');
            gSel.onchange = renderStudentTable;
        }

        function getFilteredStudents() {
            const classInput = document.getElementById('filterClassInput').value.toLowerCase();
            const fHouse = document.getElementById('filterHouse').value;
            const fGender = document.getElementById('filterGender').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            return state.students.filter(s => {
                // Manual Class Filter (Comma matching + Range support)
                if (classInput) {
                    const sClassStr = s.Class.toString().toLowerCase();
                    const sClassNum = parseFloat(sClassStr); // Extract number if possible (e.g. "1 A" -> 1)

                    const parts = classInput.split(',');
                    const match = parts.some(part => {
                        part = part.trim();
                        if (!part) return false;

                        // Range Check (e.g. "1-5")
                        if (part.includes('-')) {
                            const rangeParts = part.split('-').map(p => parseFloat(p.trim()));
                            if (rangeParts.length === 2 && !isNaN(rangeParts[0]) && !isNaN(rangeParts[1])) {
                                if (isNaN(sClassNum)) return false; // Non-numeric class cannot match numeric range
                                return sClassNum >= rangeParts[0] && sClassNum <= rangeParts[1];
                            }
                        }

                        // Direct/Prefix Match
                        return sClassStr === part || sClassStr.startsWith(part);
                    });

                    if (!match) return false;
                }

                if (fHouse && s.House != fHouse) return false;
                if (fGender && s.Gender != fGender) return false;
                if (search) {
                    const match = (s.Name.toLowerCase().includes(search) || s.Roll.toString().toLowerCase().includes(search));
                    if (!match) return false;
                }
                return true;
            });
        }

        function toggleSelectAll(checked) {
            const filtered = getFilteredStudents();
            if (checked) {
                filtered.forEach(s => selectedStudentIds.add(s.id));
            } else {
                filtered.forEach(s => selectedStudentIds.delete(s.id));
            }
            renderStudentTable();
            updateAssignButton();
        }

        function updateAssignButton() {
            const btn = document.getElementById('btnAssignQuick');
            function updateAssignButton() {
                const btn = document.getElementById('btnAssignQuick');
                if (btn) {
                    const count = selectedStudentIds.size;
                    btn.innerText = count > 0 ? `Assign to ${count}` : 'Assign';
                }
            }
        }

        function toggleSelection(id) {
            if (selectedStudentIds.has(id)) selectedStudentIds.delete(id);
            else selectedStudentIds.add(id);
            // Re-render handled by checkbox state, but we might want to update header check
            // For performance, we don't re-render whole table on single click, just update UI
            updateAssignButton();
        }

        function removeAssignment(studentId, dressId) {
            if (!confirm("Remove this dress from student?")) return;
            pushHistory();
            const arr = state.assignments[studentId];
            if (arr && Array.isArray(arr)) {
                state.assignments[studentId] = arr.filter(a => a.dressId !== dressId);
                if (state.assignments[studentId].length === 0) delete state.assignments[studentId];
            }
            saveSystem();
            renderStudentTable();
        }

        function renderStudentTable() {
            const filtered = getFilteredStudents();
            const tbody = document.getElementById('studentTable');
            document.getElementById('recordCount').innerText = `${filtered.length} Students Included`;

            updateAssignButton(); // Sync button count

            const allVisibleSelected = filtered.length > 0 && filtered.every(s => selectedStudentIds.has(s.id));

            const thead = document.querySelector('#view-data thead tr');
            if (thead) {
                thead.innerHTML = `
                    <th class="p-3 w-10"><input type="checkbox" onchange="toggleSelectAll(this.checked)" ${allVisibleSelected ? 'checked' : ''}></th>
                    <th class="p-3">Roll No</th>
                    <th class="p-3">Student Name</th>
                    <th class="p-3">Class & Sec</th>
                    <th class="p-3">House</th>
                    <th class="p-3">Gender</th>
                    <th class="p-3 text-blue-700">Assigned Dresses</th>
                    <th class="p-3 text-purple-700">Measurements</th>
                `;
            }

            if (filtered.length === 0 && state.students.length > 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-gray-500">No matches for current filters.</td></tr>`;
                return;
            } else if (state.students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="p-10 text-center text-gray-400 italic">No data imported. Upload an Excel file to begin.</td></tr>`;
                return;
            }

            const display = filtered;
            tbody.innerHTML = display.map(s => {
                let assigns = state.assignments[s.id];

                // Safety check for migration/legacy
                if (assigns && !Array.isArray(assigns)) assigns = [assigns];
                if (!assigns) assigns = [];

                const isSelected = selectedStudentIds.has(s.id);

                // Generate Aligned Rows for Dresses and Measurements
                let dressCellHtml = '';
                let measureCellHtml = '';

                if (assigns.length > 0) {
                    assigns.forEach(a => {
                        const d = state.dresses.find(dr => dr.id == a.dressId);
                        if (!d) return;

                        // Dress Pill
                        const qtyBadge = a.quantity > 1 ? `<span class="bg-blue-600 text-white text-[9px] px-1 rounded-full">${a.quantity}</span>` : '';

                        dressCellHtml += `
                            <div class="h-7 mb-1 flex items-center">
                                <span class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-200 inline-flex items-center gap-1 w-max">
                                    ${d.name} ${qtyBadge}
                                    <button onclick="removeAssignment('${s.id}', '${d.id}')" class="hover:text-red-500 font-black text-gray-400 leading-none ml-1">&times;</button>
                                </span>
                            </div>`;

                        // Measurements for THIS dress
                        const specs = d.cols.map(c =>
                            `<span class="opacity-75 text-[10px] ml-1">${c}:</span><b class="mr-1">${s[c] || '-'}</b>`
                        ).join('');

                        measureCellHtml += `
                            <div class="h-7 mb-1 flex items-center text-[10px] text-purple-700 font-mono whitespace-nowrap">
                                ${specs}
                            </div>`;
                    });
                } else {
                    dressCellHtml = `<span class="text-gray-300 text-xs italic">Unassigned</span>`;
                    measureCellHtml = `-`;
                }

                return `
                <tr class="hover:bg-gray-50 border-b border-[#F0F4F8] transition-colors ${isSelected ? 'bg-blue-50' : ''}">
                    <td class="p-3 align-top"><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection('${s.id}')"></td>
                    <td class="p-3 align-top font-mono text-xs text-gray-400 font-bold pt-4">${s.Roll}</td>
                    <td class="p-3 align-top font-semibold text-[#2C3E50] pt-4">${s.Name}</td>
                    <td class="p-3 align-top text-gray-500 text-sm pt-4">${s.Class} <span class="bg-gray-100 px-1 rounded text-[10px]">${s.Section}</span></td>
                    <td class="p-3 align-top text-gray-500 text-sm pt-4">${s.House || '-'}</td>
                    <td class="p-3 align-top text-gray-500 text-sm pt-4">${s.Gender}</td>
                    <!-- Dresses Column -->
                    <td class="p-3 align-top">
                        <div class="flex flex-col">
                            ${dressCellHtml}
                        </div>
                    </td>
                    <!-- Measurements Column -->
                    <td class="p-3 align-top">
                        <div class="flex flex-col">
                            ${measureCellHtml}
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }



        // --- MODULE 3: AI GROUPING ---
        function updateScopeDisplay() {
            const scope = document.getElementById('groupingScope').value;
            const summary = document.getElementById('scopeFilterSummary');

            if (scope === 'all') {
                summary.textContent = `Including ${state.students.length} students`;
                summary.classList.remove('hidden');
                // Ensure text color is standard
                summary.className = "text-[10px] text-gray-400";
            } else {
                // Show what filters are active
                const cls = document.getElementById('filterClassInput').value;
                const hse = document.getElementById('filterHouse').value;
                const gen = document.getElementById('filterGender').value;

                const active = [];
                if (cls) active.push(`Class: ${cls}`);
                if (hse) active.push(`House: ${hse}`);
                if (gen) active.push(`Gender: ${gen}`);

                if (active.length === 0) {
                    summary.textContent = "No filters active (All Data)";
                    summary.className = "text-[10px] text-orange-400 font-bold";
                } else {
                    summary.textContent = active.join(', ');
                    summary.className = "text-[10px] text-blue-500 font-bold";
                }
                summary.classList.remove('hidden');
            }
        }

        function runAutoGrouping() {
            if (Object.keys(state.assignments).length === 0) return alert("No students assigned to dresses yet.");

            // Determine Scope
            const scope = document.getElementById('groupingScope').value;
            let sourceStudents = state.students;

            if (scope === 'filtered') {
                sourceStudents = getFilteredStudents();
                if (sourceStudents.length === 0) return alert("Current filters match 0 students. Cannot group.");
            }

            if (!confirm(`Run SMART AI Grouping on ${sourceStudents.length} students?\n\n- Auto-Split Clean batches (~40/batch)\n- Optimize Sorting\n- This will REPLACE existing groups.`)) return;

            state.groups = [];
            const buckets = {};

            // Read Config
            const useClass = document.getElementById('cfgSplitClass').checked;
            const useSection = document.getElementById('cfgSplitSection').checked;
            const useGender = document.getElementById('cfgSplitGender').checked;
            const useHouse = document.getElementById('cfgSplitHouse').checked;
            const useMeasure = document.getElementById('cfgSplitMeasure').checked;

            sourceStudents.forEach(s => {
                let assigns = state.assignments[s.id];
                if (!assigns) return;
                if (!Array.isArray(assigns)) assigns = [assigns];

                assigns.forEach(a => {
                    const dress = state.dresses.find(d => d.id == a.dressId);
                    if (!dress) return;

                    // Build Dynamic Key
                    let parts = [dress.name];

                    // Measurement Grouping (Primary Key)
                    // If enabled, we group by the FIRST measurement column (usually Size/Chest)
                    if (useMeasure && dress.cols && dress.cols.length > 0) {
                        const primCol = dress.cols[0];
                        const val = s[primCol];
                        if (val) parts.push(`Size ${val}`);
                    }

                    if (useClass) parts.push(s.Class);
                    if (useClass && useSection) parts.push(s.Section);
                    if (useHouse && s.House) parts.push(s.House);
                    if (useGender) parts.push(s.Gender);

                    // Key for Internal Bucket
                    const key = parts.join('|');
                    if (!buckets[key]) buckets[key] = {
                        name: key,
                        dressId: dress.id,
                        studentIds: [],
                        baseParts: parts // Used for smart naming
                    };
                    buckets[key].studentIds.push(s.id);
                });
            });

            // PROCESS BUCKETS (Split & Name)
            // Goal: Max ~40 per group for manageable production batches
            const MAX_BATCH_SIZE = 40;

            Object.values(buckets).forEach((b) => {
                const total = b.studentIds.length;

                // Sort students by Roll No (or Name) to ensure "friends stay together"
                // Assuming s.Roll is numeric or alphanumeric sortable
                b.studentIds.sort((aid, bid) => {
                    const sA = state.students.find(s => s.id === aid);
                    const sB = state.students.find(s => s.id === bid);
                    return sA.Roll.toString().localeCompare(sB.Roll.toString(), undefined, { numeric: true });
                });

                if (total > MAX_BATCH_SIZE) {
                    // SPLIT LOGIC
                    let batchCount = Math.ceil(total / MAX_BATCH_SIZE);
                    let studentIndex = 0;

                    for (let i = 0; i < batchCount; i++) {
                        // Calculate chunk
                        // E.g. 60 students -> Batch A (30), Batch B (30) for equal load?
                        // Or Batch A (40), Batch B (20)?
                        // "Load Balancing" implies equal chunks. 
                        // Let's do equal chunks: 60 / 2 = 30. 100 / 3 = 33, 33, 34.

                        const chunkTarget = Math.ceil(total / batchCount);
                        const chunk = b.studentIds.slice(studentIndex, studentIndex + chunkTarget);
                        studentIndex += chunkTarget;

                        if (chunk.length === 0) continue;

                        const batchLetter = String.fromCharCode(65 + i); // A, B, C...

                        // Smart Name Generation
                        // E.g. "BOYS SHIRT | 9 A | Male" -> "B-SHIRT 9A - Batch A"
                        // Or just append "Batch A" to the long name for clarity first

                        // We will keep the descriptor but append Batch info
                        // Clean up name: Replace | with -
                        const cleanName = b.name.replace(/ \| /g, ' - ');

                        state.groups.push({
                            id: `g_${Date.now()}_${Math.random()}`,
                            name: `${cleanName} [Batch ${batchLetter}]`, // Clean Name
                            dressId: b.dressId,
                            studentIds: chunk,
                            meta: { fabric: '', notes: `Auto-Split Size: ${chunk.length} (Batch ${batchLetter})` }
                        });
                    }

                } else {
                    // NO SPLIT (Single Batch)
                    const cleanName = b.name.replace(/ \| /g, ' - ');
                    state.groups.push({
                        id: `g_${Date.now()}_${Math.random()}`,
                        name: cleanName,
                        dressId: b.dressId,
                        studentIds: b.studentIds,
                        meta: { fabric: '', notes: '' }
                    });
                }
            });

            saveSystem();
            renderGroups();
            alert(`AI Analysis Complete.\nCreated ${state.groups.length} balanced production groups.`);
        }


        function renderGroups() {
            const container = document.getElementById('groupsContainer');

            // Populate Dress Filter Dropdown if needed (idempotent)
            const dressFilter = document.getElementById('filterGroupDress');
            if (dressFilter.options.length === 1 && state.dresses.length > 0) {
                state.dresses.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.text = d.name;
                    dressFilter.appendChild(opt);
                });
            }

            // Get Filter Values
            const fDress = dressFilter.value;
            const fClass = document.getElementById('filterGroupClass').value.toLowerCase().trim();
            const fGender = document.getElementById('filterGroupGender').value;

            // Apply Filters
            let displayGroups = state.groups.filter(g => {
                const dress = state.dresses.find(d => d.id == g.dressId);

                // 1. Dress Filter
                if (fDress && g.dressId !== fDress) return false;

                // 2. Class Filter (Search in name or students)
                if (fClass) {
                    // Check group name for class match (usually "Dish | 1 A | Gender")
                    if (!g.name.toLowerCase().includes(fClass)) return false;
                }

                // 3. Gender Filter
                if (fGender) {
                    if (!g.name.includes(fGender)) return false; // Gender is usually part of group name key
                }

                return true;
            });

            if (state.groups.length === 0) {
                container.innerHTML = `<div class="w-full text-center text-gray-400 mt-20 flex flex-col items-center">
                    <span class="font-medium">No active groups. Run AI Auto-Analysis.</span>
                </div>`;
                return;
            }

            if (displayGroups.length === 0) {
                container.innerHTML = `<div class="w-full text-center text-gray-400 mt-20">
                    <span class="font-medium">No groups match your filters.</span>
                </div>`;
                return;
            }

            container.innerHTML = displayGroups.map(g => {
                const dress = state.dresses.find(d => d.id == g.dressId);
                const count = g.studentIds.length;
                const preview = g.studentIds.slice(0, 3).map(sid => {
                    const s = state.students.find(st => st.id === sid);
                    return s ? s.Name.split(' ')[0] : '?';
                }).join(', ');

                return `
                <div class="bg-white rounded shadow-sm hover:shadow border border-[#E2E8F0] w-80 flex flex-col shrink-0 transition-all">
                    <div class="p-3 border-b border-[#F0F4F8] bg-[#F9F9F7] flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-[#2C3E50] text-sm leading-tight mb-1">${g.name}</h4>
                            <span class="text-[10px] text-gray-500 font-semibold bg-gray-200 px-1.5 py-0.5 rounded">${dress ? dress.name : 'Unknown Dress'}</span>
                        </div>
                        <span class="bg-[#2C3E50] text-white text-xs font-bold px-2 py-0.5 rounded-full">${count}</span>
                    </div>
                    <div class="p-4 flex-1 space-y-3">
                        <div class="text-xs text-gray-500">
                             <span class="font-bold uppercase tracking-wider text-[10px] text-gray-400 block mb-1">Students</span>
                             ${preview} ${count > 3 ? `<span class="italic text-gray-400">+${count - 3} others</span>` : ''}
                        </div>
                        <div class="space-y-2 mt-4 text-xs text-gray-400 italic">
                             ${g.meta.fabric ? `<p><b class="not-italic text-gray-500">Fabric:</b> ${g.meta.fabric}</p>` : 'No fabric details'}
                             ${g.meta.notes ? `<p><b class="not-italic text-gray-500">Notes:</b> ${g.meta.notes}</p>` : 'No notes'}
                        </div>
                    </div>
                    <div class="px-3 py-2 bg-[#F9F9F7] border-t border-[#F0F4F8] flex justify-between items-center">
                         <button onclick="deleteGroup('${g.id}')" class="text-[10px] font-bold text-red-300 hover:text-red-500 uppercase tracking-wider">Delete</button>
                         <button onclick="openGroupDetails('${g.id}')" class="bg-white border border-[#E2E8F0] text-[#2C3E50] text-xs font-bold px-3 py-1 rounded hover:bg-gray-50 transition-colors shadow-sm">Manage / Edit</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateGroupMeta(gid, key, val) {
            const g = state.groups.find(grp => grp.id === gid);
            if (g) { g.meta[key] = val; saveSystem(); }
        }
        function deleteGroup(gid) {
            if (confirm("Delete this group?")) {
                state.groups = state.groups.filter(g => g.id !== gid);
                saveSystem();
                renderGroups();
            }
        }

        // --- MODULE 5: SMART INSIGHT LOGIC ---
        function renderAnalysis() {
            // 1. Production Overview
            const charts = document.getElementById('analysisCharts');

            // Calc stats
            const totalStudents = state.students.length;
            const totalAssigned = Object.keys(state.assignments).length; // Appx check

            // Breakdown by Dress
            let dressStats = state.dresses.map(d => {
                let count = 0;
                Object.values(state.assignments).forEach(val => {
                    const arr = Array.isArray(val) ? val : [val];
                    if (arr.some(a => a.dressId === d.id)) count++;
                });
                return { name: d.name, count };
            }).sort((a, b) => b.count - a.count);

            // Render Chart
            let chartHTML = `
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-400 text-xs uppercase">Assignment Status</h4>
                    <div class="flex items-center gap-4">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-600 h-4 rounded-full" style="width: ${totalStudents ? (totalAssigned / totalStudents) * 100 : 0}%"></div>
                        </div>
                        <span class="text-sm font-bold text-blue-600">${totalAssigned}/${totalStudents}</span>
                    </div>
                </div>
                <div class="space-y-2 mt-4 max-h-40 overflow-y-auto pr-2">
                     <h4 class="font-bold text-gray-400 text-xs uppercase">Dress Breakdown</h4>
                     ${dressStats.map(d => `
                        <div class="flex justify-between items-center text-sm">
                            <span class="truncate w-32" title="${d.name}">${d.name}</span>
                            <div class="flex-1 mx-2 bg-gray-100 h-2 rounded-full overflow-hidden">
                                <div class="bg-green-500 h-full" style="width: ${(d.count / totalStudents) * 100}%"></div>
                            </div>
                            <span class="font-bold">${d.count}</span>
                        </div>
                     `).join('')}
                </div>
            `;
            charts.innerHTML = chartHTML;

            // 2. Fabric Calculator
            const table = document.getElementById('fabricCalcTable');
            table.innerHTML = '';

            dressStats.forEach(d => {
                if (d.count === 0) return;
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="p-3 font-medium text-[#2C3E50]">${d.name}</td>
                    <td class="p-3 font-bold">${d.count}</td>
                    <td class="p-3">
                        <input type="number" step="0.1" class="border rounded p-1 w-20 text-center fabric-input" data-count="${d.count}" value="0" placeholder="0.0">
                    </td>
                    <td class="p-3 text-right font-mono font-bold text-blue-600 val-total">0.0 M</td>
                `;
                table.appendChild(tr);

                tr.querySelector('.fabric-input').addEventListener('input', (e) => {
                    const cons = parseFloat(e.target.value) || 0;
                    tr.querySelector('.val-total').textContent = `${(cons * d.count).toFixed(1)} M`;
                    recalcGrandTotal();
                });
            });

            // 3. Anomaly Detection
            const anomalyContainer = document.getElementById('anomalyList');
            anomalyContainer.innerHTML = '';
            const anomalies = [];

            state.dresses.forEach(dress => {
                if (!dress.cols) return;
                const students = state.students.filter(s => {
                    const a = state.assignments[s.id];
                    return a && (Array.isArray(a) ? a : [a]).some(x => x.dressId === dress.id);
                });
                if (students.length < 5) return;

                dress.cols.forEach(col => {
                    const values = students.map(s => parseFloat(s[col])).filter(n => !isNaN(n));
                    if (values.length < 5) return;

                    const mean = values.reduce((a, b) => a + b, 0) / values.length;
                    const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                    const stdDev = Math.sqrt(variance);

                    students.forEach(s => {
                        const val = parseFloat(s[col]);
                        if (!isNaN(val) && Math.abs((val - mean) / stdDev) > 3.0) {
                            anomalies.push(`${s.Name} (${s.Class}): ${dress.name} ${col}=${val} (Avg ${mean.toFixed(1)})`);
                        }
                    });
                });
            });

            if (anomalies.length === 0) anomalyContainer.innerHTML = '<p class="text-sm text-green-600">✅ All clean.</p>';
            else {
                anomalies.slice(0, 50).forEach(msg => {
                    const d = document.createElement('div');
                    d.className = "text-xs bg-red-50 p-2 border border-red-100 text-red-700 rounded mb-1";
                    d.innerText = msg;
                    anomalyContainer.appendChild(d);
                });
            }
        }

        function recalcGrandTotal() {
            let total = 0;
            document.querySelectorAll('.val-total').forEach(el => total += parseFloat(el.innerText) || 0);
            document.getElementById('fabricGrandTotal').innerText = total.toFixed(1) + " M";
        }

        // --- EXPORT LOGIC ---
        function exportFullExcel() {
            if (state.groups.length === 0) return alert("No groups to export.");
            const wb = XLSX.utils.book_new();

            // 1. Summary Sheet
            const summaryData = state.groups.map(g => {
                const dress = state.dresses.find(d => d.id == g.dressId);
                return {
                    "Group Name": g.name,
                    "Dress Type": dress ? dress.name : 'Unknown',
                    "Student Count": g.studentIds.length,
                    "Fabric": g.meta.fabric || '',
                    "Notes": g.meta.notes || ''
                };
            });
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Overview");

            // 2. Master List (All Students)
            const masterData = [];
            state.groups.forEach(g => {
                const dress = state.dresses.find(d => d.id == g.dressId);
                g.studentIds.forEach(sid => {
                    const s = state.students.find(st => st.id === sid);
                    if (s) {
                        const row = {
                            "Group": g.name,
                            "Dress": dress ? dress.name : '',
                            "Roll No": s.Roll,
                            "Name": s.Name,
                            "Class": s.Class,
                            "Section": s.Section,
                            "Gender": s.Gender
                        };

                        // ADD QUANTITY
                        let qty = 1;
                        const assigns = state.assignments[sid];
                        if (assigns) {
                            const arr = Array.isArray(assigns) ? assigns : [assigns];
                            const match = arr.find(a => a.dressId == g.dressId);
                            if (match && match.quantity) qty = match.quantity;
                        }
                        row["Quantity"] = qty;

                        // Add ALL Measurements (Full Data Dump)
                        const allMeasures = ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'L1', 'L2', 'L3', 'L4', 'L5', 'L6', 'L7', 'L8'];
                        allMeasures.forEach(m => {
                            row[m] = s[m] || '';
                        });

                        masterData.push(row);
                    }
                });
            });
            const wsMaster = XLSX.utils.json_to_sheet(masterData);
            XLSX.utils.book_append_sheet(wb, wsMaster, "All Students");

            // 3. Individual Group Sheets
            state.groups.forEach((g, i) => {
                const dress = state.dresses.find(d => d.id == g.dressId);
                const groupData = g.studentIds.map(sid => {
                    const s = state.students.find(st => st.id === sid);
                    if (!s) return null;
                    const row = {
                        "Roll": s.Roll,
                        "Name": s.Name,
                        "Class": `${s.Class} ${s.Section}`,
                    };

                    // ADD QUANTITY
                    let qty = 1;
                    const assigns = state.assignments[sid];
                    if (assigns) {
                        const arr = Array.isArray(assigns) ? assigns : [assigns];
                        const match = arr.find(a => a.dressId == g.dressId);
                        if (match && match.quantity) qty = match.quantity;
                    }
                    row["Qty"] = qty;
                    if (dress) dress.cols.forEach(c => row[c] = s[c]);
                    return row;
                }).filter(r => r !== null);

                // Sheet Name (Sanitized, max 31 chars)
                let sheetName = `${i + 1}. ${g.name}`.replace(/[\\/?*\[\]]/g, "").substring(0, 31);


                const wsGroup = XLSX.utils.json_to_sheet(groupData);
                XLSX.utils.book_append_sheet(wb, wsGroup, sheetName);
            });

            // 4. METADATA (Hidden Sheet for Restoration)
            // Fix: Split JSON into chunks of 30,000 chars to avoid Excel 32k cell limit
            const fullJson = JSON.stringify(state);
            const chunkSize = 30000;
            const chunks = [];
            for (let i = 0; i < fullJson.length; i += chunkSize) {
                chunks.push({ "CHUNK_ID": i / chunkSize, "DATA_CHUNK": fullJson.substring(i, i + chunkSize) });
            }
            const wsMeta = XLSX.utils.json_to_sheet(chunks);
            XLSX.utils.book_append_sheet(wb, wsMeta, "System_Metadata");

            XLSX.writeFile(wb, "Production_Plan_Master.xlsx");
        }

        function exportGroupPDFs() {
            if (state.groups.length === 0) return alert("No groups to export.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 10;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 10;

            state.groups.forEach((g, i) => {
                // Estimate Header Height (Title + Meta) approx 30mm
                // If current Y + 30 > pageHeight, add page
                if (y + 40 > pageHeight) {
                    doc.addPage();
                    y = margin;
                }

                const dress = state.dresses.find(d => d.id == g.dressId);

                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(g.name, margin, y);
                y += 6;

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Dress: ${dress ? dress.name : '-'} | Count: ${g.studentIds.length}`, margin, y);
                y += 5;
                doc.text(`Fabric: ${g.meta.fabric || '-'} | Notes: ${g.meta.notes || '-'}`, margin, y);
                y += 8;

                const headers = ["Roll", "Name", "Class", "Qty", ...(dress ? dress.cols : [])];
                const rows = g.studentIds.map(sid => {
                    const s = state.students.find(st => st.id === sid);
                    if (!s) return [];

                    // Lookup Quantity
                    let qty = 1;
                    const assigns = state.assignments[sid];
                    if (assigns && Array.isArray(assigns)) {
                        const match = assigns.find(a => a.dressId == g.dressId);
                        if (match && match.quantity) qty = match.quantity;
                    }

                    return [s.Roll, s.Name, `${s.Class} ${s.Section}`, qty, ...(dress ? dress.cols.map(c => s[c]) : [])];
                });

                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: y,
                    theme: 'grid',
                    headStyles: { fillColor: [44, 62, 80], fontSize: 8, cellPadding: 2 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    margin: { left: margin, right: margin },
                    pageBreak: 'auto',
                    rowPageBreak: 'avoid',
                    // Important: Update y after table
                    didDrawPage: function (data) {
                        // Reset Y if table spans multiple pages
                        y = margin;
                    }
                });

                // Update Y for next group
                y = doc.lastAutoTable.finalY + 15; // 15mm gap between groups
            });

            doc.save("Production_Cards_Optimized.pdf");
        }

        function triggerImport() {
            document.getElementById('importInput').click();
        }

        function importSystemFromExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Look for Metadata Sheet
                const metaSheet = workbook.Sheets["System_Metadata"];
                if (!metaSheet) {
                    alert("This Excel file does not contain Valid System Metadata (Sheet: System_Metadata). Cannot restore full system.");
                    return;
                }

                try {
                    // Reassemble JSON from Chunks
                    const jsonRows = XLSX.utils.sheet_to_json(metaSheet);
                    // Rows are like: { CHUNK_ID: 0, DATA_CHUNK: "..." }
                    // Sort just in case order messed up
                    jsonRows.sort((a, b) => a.CHUNK_ID - b.CHUNK_ID);

                    let fullJson = "";
                    jsonRows.forEach(row => {
                        if (row.DATA_CHUNK) fullJson += row.DATA_CHUNK;
                    });

                    if (fullJson.length > 0) {
                        const newState = JSON.parse(fullJson);

                        // Restore
                        if (confirm(`Found Backup with ${newState.groups?.length || 0} groups. Restore? This OVERWRITES current data.`)) {
                            // Ensure clean state structure
                            state = newState;
                            saveSystem();
                            refreshAll();
                            alert("System Restored Successfully from Excel!");
                            input.value = ''; // Reset
                        }
                    } else {
                        throw new Error("Metadata empty");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Failed to parse system data from Excel file. Corrupt Metadata?");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- GROUP DETAILS MODAL LOGIC ---


        function openGroupDetails(gid) {
            currentGroupId = gid;
            const g = state.groups.find(grp => grp.id === gid);
            if (!g) return;

            const dress = state.dresses.find(d => d.id == g.dressId);

            // Header
            document.getElementById('gdModalTitle').textContent = g.name;
            document.getElementById('gdModalSubtitle').textContent = `${dress ? dress.name : 'Unknown Dress'} • ${g.studentIds.length} Students`;

            // Populate Inputs (From first student, as per grouping logic)
            // Populate Inputs (Smart Scan)
            // If group has mixed Classes or Sections, we leave inputs BLANK to imply "Mixed/All".
            // Otherwise we pre-fill.
            let uniqueClasses = new Set();
            let uniqueSections = new Set();
            let uniqueGenders = new Set();

            g.studentIds.forEach(sid => {
                const s = state.students.find(st => st.id === sid);
                if (s) {
                    uniqueClasses.add(String(s.Class).trim());
                    uniqueSections.add(String(s.Section || '').trim());
                    uniqueGenders.add(s.Gender);
                }
            });

            if (uniqueClasses.size === 1) {
                document.getElementById('gdEditClass').value = [...uniqueClasses][0];
            } else {
                document.getElementById('gdEditClass').value = ''; // Mixed
            }

            if (uniqueSections.size === 1) {
                document.getElementById('gdEditSection').value = [...uniqueSections][0];
            } else {
                document.getElementById('gdEditSection').value = ''; // Mixed
            }

            if (uniqueGenders.size === 1) {
                document.getElementById('gdEditGender').value = [...uniqueGenders][0];
            } else {
                // Warning: Select might default to first option 'Male' if we don't handle this.
                // But we have limited options. Let's just leave it or set to empty if possible?
                // The select has Male/Female. We can't set it to blank unless we add an option.
                // Let's assume Gender is usually consistent.
                document.getElementById('gdEditGender').value = [...uniqueGenders][0];
            }
            document.getElementById('gdCriteriaDress').textContent = dress ? dress.name : 'Unknown';

            // Inputs
            document.getElementById('gdFabric').value = g.meta.fabric || '';
            document.getElementById('gdNotes').value = g.meta.notes || '';

            renderGroupModalStudents();
            renderGroupStats(g, dress); // New function call
            document.getElementById('groupDetailModal').classList.remove('hidden');
        }

        function recalculateGroupScope() {
            const g = state.groups.find(grp => grp.id === currentGroupId);
            if (!g) return;
            const dress = state.dresses.find(d => d.id == g.dressId);
            if (!dress) return;

            pushHistory(); // Capture state BEFORE modification

            // Gather Inputs (Loose)
            const targetClass = String(document.getElementById('gdEditClass').value).trim().toLowerCase();
            const targetSection = String(document.getElementById('gdEditSection').value).trim().toLowerCase();
            const targetGender = document.getElementById('gdEditGender').value;

            // Gather Size Constraints from Inputs
            const sizeConstraints = {};
            let activeSizeFilters = 0;
            if (dress.cols) {
                dress.cols.forEach(col => {
                    const minInput = document.getElementById(`gdSizeMin_${col}`);
                    const maxInput = document.getElementById(`gdSizeMax_${col}`);

                    if (minInput && maxInput) {
                        // FIX: Treat EMPTY String as "Don't Filter"
                        // Treat "0" as strict value 0.
                        const minStr = minInput.value;
                        const maxStr = maxInput.value;

                        if (minStr !== '' && maxStr !== '') {
                            const minVal = parseFloat(minStr);
                            const maxVal = parseFloat(maxStr);

                            // Only exclude if it's explicitly 0-0 AND user hasn't typed anything? 
                            // No, if user typed 0 and 0, they want 0.
                            // Logic: If input is NOT empty, apply filter.
                            sizeConstraints[col] = { min: minVal, max: maxVal };
                            activeSizeFilters++;
                        }
                    }
                });
            }

            console.log("--- DEBUG FILTER START ---");
            console.log("Target Class:", targetClass);
            console.log("Target Section:", targetSection);
            console.log("Target Gender:", targetGender);
            console.log("Size Constraints:", sizeConstraints);

            let failReason = "";

            // Find matching students in ENTIRE system
            const matches = state.students.filter(s => {
                // Check Dress Assignment
                const assigns = state.assignments[s.id];
                if (!assigns) return false;
                const arr = Array.isArray(assigns) ? assigns : [assigns];
                const hasDress = arr.some(a => a.dressId === dress.id);
                if (!hasDress) return false;

                // Check Scope (Loose Type Check)
                // Check Scope (Loose Type Check)
                // Fix: Allow Wildcard (Empty Input Matches All)
                if (targetClass && String(s.Class).trim().toLowerCase() !== targetClass) {
                    if (!failReason) failReason = `Class Mismatch (Exp: ${targetClass}, Got: ${s.Class})`;
                    return false;
                }

                // Section might be optional/empty in data
                const sSection = String(s.Section || '').trim().toLowerCase();
                if (targetSection && sSection !== targetSection) {
                    if (!failReason) failReason = `Section Mismatch (Exp: ${targetSection}, Got: ${sSection})`;
                    return false;
                }

                if (s.Gender !== targetGender) {
                    if (!failReason) failReason = `Gender Mismatch (Exp: ${targetGender}, Got: ${s.Gender})`;
                    return false;
                }

                // Check Size Constraints
                for (const col in sizeConstraints) {
                    const val = parseFloat(s[col]);
                    // If student data is missing, we exclude them ONLY if strict filter applied
                    const compareVal = isNaN(val) ? 0 : val;

                    if (compareVal < sizeConstraints[col].min || compareVal > sizeConstraints[col].max) {
                        if (!failReason) failReason = `Size ${col} ${compareVal} not in ${sizeConstraints[col].min}-${sizeConstraints[col].max}`;
                        return false;
                    }
                }

                return true;
            });

            console.log(`Matched: ${matches.length} students.`);
            if (matches.length === 0) console.log("Sample Fail Reason:", failReason);
            console.log("--- DEBUG FILTER END ---");

            if (matches.length === 0) {
                alert(`No students found matching these new criteria!\n\nDebug Info:\nLast Failure Reason: ${failReason || 'Unknown'}\nActive Size Filters: ${activeSizeFilters}\n\nCheck Console (F12) for more details.`);
                return;
            }

            // Update Group
            g.studentIds = matches.map(s => s.id);
            g.name = `${dress.name} | ${document.getElementById('gdEditClass').value} ${document.getElementById('gdEditSection').value} | ${targetGender}`;

            saveSystem();
            renderGroups();

            // Refresh Modal Internals
            renderGroupModalStudents();
            renderGroupStats(g, dress, sizeConstraints);

            document.getElementById('gdModalSubtitle').textContent = `${dress.name} • ${g.studentIds.length} Students`;

            // Auto close/feedback
            const btn = document.querySelector('#gdModal button[onclick="recalculateGroupScope()"]');
            if (btn) {
                const originalText = btn.innerText;
                btn.innerText = "Updated! ✓";
                btn.classList.add('bg-green-600', 'text-white');
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.remove('bg-green-600', 'text-white');
                }, 1500);
            }
        }

        function renderGroupStats(g, dress, overrides = {}) {
            const container = document.getElementById('gdStats');
            if (!dress || g.studentIds.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 italic">No measurement data.</p>';
                return;
            }

            // Calculate Stats for each column
            const stats = dress.cols.map(col => {
                let values = g.studentIds.map(sid => {
                    const s = state.students.find(st => st.id === sid);
                    return s ? parseFloat(s[col]) : NaN;
                }).filter(v => !isNaN(v));

                // If override exists, use it. Otherwise use actual stats.
                let minVal, maxVal;

                if (overrides[col]) {
                    minVal = overrides[col].min;
                    maxVal = overrides[col].max;
                } else if (values.length > 0) {
                    minVal = Math.min(...values);
                    maxVal = Math.max(...values);
                } else {
                    minVal = ''; // Default to blank
                    maxVal = '';
                }

                // Treat 0 as blank for initial render to avoid confusion?
                // If the entire group is 0 (e.g. no measurements), show blank.
                if (minVal === 0 && maxVal === 0) {
                    minVal = '';
                    maxVal = '';
                }

                return { col, min: minVal, max: maxVal };
            });

            // Render with Inputs
            let html = stats.map(s => {
                // FORCE BLANK if 0 or empty
                const minDisplay = (s.min === 0 || s.min === '' || s.min === '-') ? '' : s.min;
                const maxDisplay = (s.max === 0 || s.max === '' || s.max === '-') ? '' : s.max;

                return `
                <div class="flex justify-between items-center text-xs border-b border-[#F0F4F8] last:border-0 pb-2 last:pb-0">
                    <span class="font-mono text-gray-500 font-bold w-8">${s.col}</span>
                    <div class="flex items-center gap-1 flex-1 justify-end">
                         <input type="number" id="gdSizeMin_${s.col}" value="${minDisplay}" class="w-12 text-center border border-gray-200 rounded px-1 py-0.5 text-[#2C3E50] font-bold text-xs focus:border-blue-400 outline-none hover:bg-gray-50 bg-gray-50/50" placeholder="Min">
                         <span class="text-gray-300">-</span>
                         <input type="number" id="gdSizeMax_${s.col}" value="${maxDisplay}" class="w-12 text-center border border-gray-200 rounded px-1 py-0.5 text-[#2C3E50] font-bold text-xs focus:border-blue-400 outline-none hover:bg-gray-50 bg-gray-50/50" placeholder="Max">
                    </div>
                </div>`;
            }).join('');

            // Add Apply Button
            html += `
            <div class="mt-3 pt-2 border-t border-gray-100 flex gap-2">
                 <button onclick="clearSizeFilters()" class="w-1/3 bg-gray-50 hover:bg-gray-100 text-gray-400 hover:text-red-400 text-xs font-bold py-1.5 rounded transition-colors uppercase tracking-wider relative group">
                    Reset
                    <span class="absolute bottom-full mb-1 hidden group-hover:block bg-black text-white text-[10px] p-1 rounded whitespace-nowrap left-1/2 -translate-x-1/2">Clear All Constraints</span>
                </button>
                <button onclick="recalculateGroupScope()" class="w-2/3 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-bold py-1.5 rounded transition-colors uppercase tracking-wider">
                    Apply Size Filters
                </button>
            </div>
            `;

            container.innerHTML = html;
        }

        function clearSizeFilters() {
            // Find all inputs starting with gdSizeMin or gdSizeMax
            document.querySelectorAll('input[id^="gdSizeMin_"], input[id^="gdSizeMax_"]').forEach(el => {
                el.value = '';
            });
        }

        function renderGroupModalStudents() {
            const g = state.groups.find(grp => grp.id === currentGroupId);
            if (!g) return;

            const dress = state.dresses.find(d => d.id == g.dressId);
            const tbody = document.getElementById('gdStudentList');

            tbody.innerHTML = g.studentIds.map(sid => {
                const s = state.students.find(st => st.id === sid);
                if (!s) return '';

                const specs = dress ? dress.cols.map(c => `<span class="opacity-50">${c}:</span><b>${s[c] || '-'}</b>`).join(' ') : '-';

                return `
                <tr class="hover:bg-gray-50 group">
                    <td class="p-3 font-mono text-xs text-gray-500 font-bold">${s.Roll}</td>
                    <td class="p-3 font-semibold text-[#2C3E50]">${s.Name}</td>
                    <td class="p-3 font-mono text-xs text-purple-700">${specs}</td>
                    <td class="p-3 text-right">
                        <button onclick="removeFromGroup('${sid}')" class="text-red-300 hover:text-red-500 font-bold text-xs uppercase tracking-wider opacity-0 group-hover:opacity-100 transition-opacity">Remove</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function removeFromGroup(sid) {
            if (!confirm("Remove student from this group?")) return;
            const g = state.groups.find(grp => grp.id === currentGroupId);
            if (g) {
                g.studentIds = g.studentIds.filter(id => id !== sid);
                // Update subtitle count
                const dress = state.dresses.find(d => d.id == g.dressId);
                document.getElementById('gdModalSubtitle').textContent = `${dress ? dress.name : 'Unknown Dress'} • ${g.studentIds.length} Students`;
                saveSystem();
                renderGroupModalStudents();
                renderGroups(); // Update main view too
            }
        }

        function saveGroupDetailsFromModal() {
            const g = state.groups.find(grp => grp.id === currentGroupId);
            if (g) {
                pushHistory();
                g.meta.fabric = document.getElementById('gdFabric').value;
                g.meta.notes = document.getElementById('gdNotes').value;
                saveSystem();
                renderGroups();
                alert("Details Saved!");
                document.getElementById('groupDetailModal').classList.add('hidden');
            }
        }

        // Init
        // Init
        window.addEventListener('DOMContentLoaded', () => {
            loadSystem();
            const lastTab = sessionStorage.getItem('activeTab') || 'config';
            switchTab(lastTab);
        });
    </script>
    <!-- Group Detail Modal -->
    <div id="groupDetailModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[80vh] flex flex-col animate-in fade-in zoom-in duration-200">
            <!-- Header -->
            <div class="p-6 border-b border-[#E2E8F0] flex justify-between items-center bg-gray-50 rounded-t-lg">
                <div>
                    <h3 id="gdModalTitle" class="text-xl font-bold text-[#2C3E50]">Group Details</h3>
                    <p id="gdModalSubtitle" class="text-sm text-gray-500">Manage students and production notes</p>
                </div>
                <button onclick="document.getElementById('groupDetailModal').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Body -->
            <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                <!-- Left: Student List -->
                <div class="flex-1 overflow-auto p-0 border-r border-[#E2E8F0] relative">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-gray-50 sticky top-0 z-10 border-b border-[#E2E8F0] text-xs uppercase text-gray-500 font-bold">
                            <tr>
                                <th class="p-3">Roll</th>
                                <th class="p-3">Name</th>
                                <th class="p-3">Measurements</th>
                                <th class="p-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="gdStudentList" class="divide-y divide-gray-100">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Right: Meta Features -->
                <div class="w-full md:w-80 bg-[#F9F9F7] p-6 flex flex-col gap-6 shrink-0 overflow-auto">
                    <!-- Batch Criteria Widget -->
                    <div class="bg-white p-4 rounded border border-[#E2E8F0] shadow-sm">
                        <h4
                            class="text-xs font-bold text-[#2C3E50] uppercase tracking-wider mb-2 border-b border-gray-100 pb-2 flex justify-between items-center">
                            Batch Scope
                            <span class="text-[9px] text-gray-400 bg-gray-100 px-1 rounded">Editable</span>
                        </h4>
                        <div class="space-y-2 text-xs">
                            <div class="flex flex-col gap-1">
                                <span class="text-gray-400 text-[10px] font-bold">Class & Section</span>
                                <div class="flex gap-2">
                                    <input type="text" id="gdEditClass"
                                        class="w-16 border border-[#E2E8F0] rounded px-2 py-1 text-xs font-bold text-[#2C3E50]"
                                        placeholder="Class">
                                    <input type="text" id="gdEditSection"
                                        class="w-16 border border-[#E2E8F0] rounded px-2 py-1 text-xs font-bold text-[#2C3E50]"
                                        placeholder="Sec">
                                </div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <span class="text-gray-400 text-[10px] font-bold">Gender</span>
                                <select id="gdEditGender"
                                    class="w-full border border-[#E2E8F0] rounded px-2 py-1 text-xs font-bold text-[#2C3E50]">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-50 mt-2">
                                <span class="text-gray-400">Dress Code</span>
                                <span id="gdCriteriaDress"
                                    class="font-bold text-[#2C3E50] text-right truncate w-24">-</span>
                            </div>
                            <button onclick="recalculateGroupScope()"
                                class="w-full mt-2 bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100 text-[10px] font-bold py-1.5 rounded transition-colors uppercase tracking-wider">
                                Update / Rearrange Group
                            </button>
                        </div>
                    </div>

                    <!-- Measurement Stats Widget -->
                    <div class="bg-white p-4 rounded border border-[#E2E8F0] shadow-sm">
                        <h4
                            class="text-xs font-bold text-[#2C3E50] uppercase tracking-wider mb-3 pb-2 border-b border-gray-100 flex justify-between items-center">
                            Size Analysis
                            <span class="text-[9px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">Range</span>
                        </h4>
                        <div id="gdStats" class="space-y-2">
                            <!-- Populated by JS -->
                            <p class="text-xs text-gray-400 italic">No data available.</p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Fabric
                            Details</label>
                        <input type="text" id="gdFabric"
                            class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-400 outline-none"
                            placeholder="e.g. Cotton Blue">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Production
                            Notes</label>
                        <textarea id="gdNotes"
                            class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-400 outline-none h-32 resize-none"
                            placeholder="Special instructions..."></textarea>
                    </div>
                    <div class="mt-auto pt-6 border-t border-[#E2E8F0]">
                        <button onclick="saveGroupDetailsFromModal()"
                            class="w-full bg-[#2C3E50] text-white font-bold py-3 rounded hover:bg-[#1a252f] transition-colors shadow-lg shadow-blue-900/10">
                            Save Changes
                        </button>
                        <p class="text-[10px] text-gray-400 text-center mt-2">Changes are auto-saved to system.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ASSIGNMENT MODAL -->
    <div id="assignmentModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md animate-in fade-in zoom-in duration-200">
            <div class="p-5 border-b border-[#E2E8F0] bg-[#F9F9F7] flex justify-between items-center">
                <h3 class="font-bold text-[#2C3E50] text-lg">Assign Dress</h3>
                <button onclick="closeAssignmentModal()" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Select Dress</label>
                    <select id="modalAssignDress"
                        class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Quantity</label>
                    <input type="number" id="modalAssignQty" value="1" min="1"
                        class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                </div>
                <div class="bg-blue-50 p-3 rounded border border-blue-100 text-xs text-blue-700">
                    Applying to: <span id="modalAssignCount" class="font-bold">0 students</span>
                </div>
            </div>
            <div class="p-4 bg-[#F9F9F7] border-t border-[#E2E8F0] flex justify-end gap-3">
                <button onclick="closeAssignmentModal()" class="btn-outline px-4 py-2 rounded text-sm">Cancel</button>
                <button onclick="confirmAssignment()"
                    class="btn-action px-4 py-2 rounded text-sm font-bold shadow-sm">Confirm Assignment</button>
            </div>
        </div>
    </div>

    <script>
        // --- ASSIGNMENT LOGIC ---

        // 1. Quick Assign (Old Way)
        function assignDressQuick() {
            const dressId = document.getElementById('assignDressSelect').value;
            if (!dressId) return alert("Please select a dress from the dropdown first.");
            if (selectedStudentIds.size === 0) return alert("No students selected.");

            pushHistory();

            selectedStudentIds.forEach(sid => {
                let current = state.assignments[sid] || [];
                if (!Array.isArray(current)) current = [current];

                // Append if not exact duplicate (allow multiple same dress? User usually wants 1 per type unless specified)
                // For Quick Assign, let's assume if they have it, we ADD another? Or ignore?
                // Standard behavior: Add.
                // But let's check duplicates for safety to prevent double-click accidents?
                // "Old Way" didn't have Qty, so it implied "Have/Not Have".
                // Let's safe-guard: If they have this dress id, DO NOTHING?
                // Or user might want 2 shirts.
                // Let's add it.

                // Consistency check: Remove EXACT dressId match first if we want 'Update' behavior?
                // Let's do: Add new entry.
                current.push({ dressId, quantity: 1, assignedAt: Date.now() });
                state.assignments[sid] = current;
            });

            saveSystem();
            renderStudentTable();
            alert(`Quick Assigned to ${selectedStudentIds.size} students.`);
        }

        // 2. Modal Logic (New Way)
        function openAssignmentModal() {
            if (selectedStudentIds.size === 0) return alert("Please select at least one student first.");
            updateDressDropdowns();
            document.getElementById('modalAssignCount').innerText = `${selectedStudentIds.size} students`;
            document.getElementById('modalAssignQty').value = 1;
            document.getElementById('assignmentModal').classList.remove('hidden');
        }

        function closeAssignmentModal() {
            document.getElementById('assignmentModal').classList.add('hidden');
        }

        function confirmAssignment() {
            const dressId = document.getElementById('modalAssignDress').value;
            const qty = parseInt(document.getElementById('modalAssignQty').value);

            if (!dressId) return alert("Please select a dress.");
            if (isNaN(qty) || qty < 1) return alert("Invalid quantity.");

            pushHistory();

            selectedStudentIds.forEach(sid => {
                let current = state.assignments[sid] || [];
                if (!Array.isArray(current)) current = [current];

                // Check if already assigned
                if (current.some(a => a.dressId === dressId)) {
                    current = current.filter(a => a.dressId !== dressId);
                }

                current.push({ dressId, quantity: qty, assignedAt: Date.now() });
                state.assignments[sid] = current;
            });

            saveSystem();
            renderStudentTable();
            closeAssignmentModal();
            alert(`Assigned to ${selectedStudentIds.size} students!`);
        }

        // Placeholder for updateDressDropdowns - assuming it exists elsewhere or will be defined
        // This function needs to populate the 'manualGroupDress' select element

    </script>
    <!-- MANUAL GROUP MODAL -->
    <div id="manualGroupModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md animate-in fade-in zoom-in duration-200">
            <div class="p-5 border-b border-[#E2E8F0] bg-[#F9F9F7] flex justify-between items-center">
                <h3 class="font-bold text-[#2C3E50] text-lg">Create Group Manually</h3>
                <button onclick="closeManualGroupModal()" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Group Name</label>
                    <input type="text" id="manualGroupName" placeholder="e.g. Batch A - Special"
                        class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Target Dress</label>
                    <select id="manualGroupDress" onchange="renderManualGroupMeasurements()"
                        class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Filter Class</label>
                        <input type="text" id="manualGroupClass" placeholder="e.g. 1"
                            class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Filter Section</label>
                        <input type="text" id="manualGroupSection" placeholder="e.g. A"
                            class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Filter House</label>
                        <input type="text" id="manualGroupHouse" placeholder="e.g. Red"
                            class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Filter Gender</label>
                    <select id="manualGroupGender"
                        class="w-full border border-[#E2E8F0] rounded p-2 text-sm focus:border-blue-500 outline-none">
                        <option value="">Any</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>

                <!-- Measurement Filters (Dynamic) -->
                <div id="manualGroupMeasurements" class="space-y-2 border-t border-gray-100 pt-2">
                    <!-- Populated by JS -->
                </div>

                <div class="bg-orange-50 p-3 rounded border border-orange-100 text-xs text-orange-700">
                    <span class="font-bold">Note:</span> This will create a group and extract students matching these
                    criteria who are <b>Assigned</b> the selected dress.
                </div>
            </div>
            <div class="p-4 bg-[#F9F9F7] border-t border-[#E2E8F0] flex justify-end gap-3">
                <button onclick="closeManualGroupModal()" class="btn-outline px-4 py-2 rounded text-sm">Cancel</button>
                <button onclick="createManualGroup()"
                    class="btn-action px-4 py-2 rounded text-sm font-bold shadow-sm">Create Group</button>
            </div>
        </div>
    </div>

    <script>
        function openManualGroupModal() {
            updateDressDropdowns();
            document.getElementById('manualGroupName').value = '';
            document.getElementById('manualGroupClass').value = '';
            document.getElementById('manualGroupSection').value = '';
            // Check if House exists (safety)
            const hse = document.getElementById('manualGroupHouse');
            if (hse) hse.value = '';
            document.getElementById('manualGroupGender').value = '';
            document.getElementById('manualGroupMeasurements').innerHTML = ''; // Clear old inputs
            document.getElementById('manualGroupModal').classList.remove('hidden');
        }

        function renderManualGroupMeasurements() {
            const dressId = document.getElementById('manualGroupDress').value;
            const container = document.getElementById('manualGroupMeasurements');
            container.innerHTML = '';

            if (!dressId) return;

            const dress = state.dresses.find(d => d.id === dressId);
            if (!dress || !dress.cols) return;

            container.innerHTML = `<label class="block text-xs font-bold text-[#7F8C8D] uppercase mb-1">Measurement Strategy</label>` +
                dress.cols.map(col => `
                <div class="flex items-center gap-2 mb-1">
                    <span class="w-10 text-[10px] font-bold text-gray-500 font-mono">${col}</span>
                    <input type="number" id="mg_min_${col}" placeholder="Min" class="w-16 border border-[#E2E8F0] rounded px-2 py-1 text-xs outline-none focus:border-blue-500">
                    <span class="text-gray-300 text-xs">-</span>
                    <input type="number" id="mg_max_${col}" placeholder="Max" class="w-16 border border-[#E2E8F0] rounded px-2 py-1 text-xs outline-none focus:border-blue-500">
                </div>
            `).join('');
        }

        function closeManualGroupModal() {
            document.getElementById('manualGroupModal').classList.add('hidden');
        }

        function createManualGroup() {
            const name = document.getElementById('manualGroupName').value;
            const dressId = document.getElementById('manualGroupDress').value;
            const cls = document.getElementById('manualGroupClass').value.trim();
            const sec = document.getElementById('manualGroupSection').value.trim();
            const gen = document.getElementById('manualGroupGender').value;

            if (!name || !dressId) return alert("Group Name and Dress are required.");

            // Get Measurement Filters
            const dress = state.dresses.find(d => d.id === dressId);
            const rangeFilters = [];
            if (dress && dress.cols) {
                dress.cols.forEach(col => {
                    const min = parseFloat(document.getElementById(`mg_min_${col}`).value);
                    const max = parseFloat(document.getElementById(`mg_max_${col}`).value);

                    // Ignore if both are 0 (User likely means "ignore")
                    if (min === 0 && max === 0) return;

                    if (!isNaN(min) || !isNaN(max)) {
                        rangeFilters.push({ col, min, max });
                    }
                });
            }

            // detailed counters for debugging
            let countFilters = 0;
            let countAssigned = 0;
            let countMeasurements = 0;

            // Find Students
            const candidates = state.students.filter(s => {
                // 1. Check Filters (Class, Sec, Gender)
                if (cls && String(s.Class).trim() !== cls) return false;
                if (sec && String(s.Section).trim() !== sec) return false;
                if (gen && s.Gender !== gen) return false;
                countFilters++;

                // 2. Check Dress Assignment
                const assigns = state.assignments[s.id];
                let hasDress = false;
                if (assigns) {
                    const arr = Array.isArray(assigns) ? assigns : [assigns];
                    hasDress = arr.some(a => a.dressId === dressId);
                }
                if (!hasDress) return false;
                countAssigned++;

                // 3. Check Ranges
                if (rangeFilters.length > 0) {
                    const pass = rangeFilters.every(f => {
                        const val = parseFloat(s[f.col]);
                        if (isNaN(val)) return false;
                        if (!isNaN(f.min) && val < f.min) return false;
                        if (!isNaN(f.max) && val > f.max) return false;
                        return true;
                    });
                    if (!pass) return false;
                }
                countMeasurements++;

                return true;
            });

            if (candidates.length === 0) {
                return alert(`No students found!\n\nDiagnostic:\n- Matches Class/Sec/Gender Filter: ${countFilters}\n- Has '${dress.name}' Assigned: ${countAssigned}\n- Matches Measurements: ${countMeasurements}\n\nPlease check if students are assigned this dress or if measurement ranges are too strict.`);
            }

            pushHistory();

            state.groups.push({
                id: `g_${Date.now()}`,
                name: name,
                dressId: dressId,
                studentIds: candidates.map(s => s.id),
                meta: { fabric: '', notes: 'Manually Created' }
            });

            saveSystem();
            renderGroups();
            closeManualGroupModal();
            alert(`Group "${name}" created with ${candidates.length} students.`);
        }
    </script>
</body>

</html>